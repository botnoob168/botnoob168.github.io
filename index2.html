<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏•‡∏≤‡∏î</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        
        .spreadsheet-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .spreadsheet-table th {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            border: none;
            font-size: 13px;
        }
        .spreadsheet-table td {
            border-bottom: 1px solid #e5e7eb;
            padding: 10px 8px;
            vertical-align: middle;
            background: white;
            transition: all 0.2s ease;
            font-size: 14px;
        }
        .spreadsheet-table tr:hover td {
            background: #f9fafb;
        }
        .row-number {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            font-weight: 600;
            text-align: center;
            width: 40px;
            min-width: 40px;
        }
        .editable-cell {
            cursor: pointer;
            min-height: 20px;
        }
        .editable-cell:hover {
            background: rgba(79, 70, 229, 0.1) !important;
        }
        .cell-input {
            border: 2px solid #4f46e5;
            outline: none;
            background: white;
            color: #1f2937;
            width: 100%;
            padding: 4px 8px;
            font-size: 14px;
        }
        .status-paid { 
            background: #10b981; 
            color: white; 
            padding: 4px 8px; 
            border-radius: 12px; 
            font-size: 12px; 
            font-weight: 600;
            text-align: center;
        }
        .status-pending { 
            background: #f59e0b; 
            color: white; 
            padding: 4px 8px; 
            border-radius: 12px; 
            font-size: 12px; 
            font-weight: 600;
            text-align: center;
        }
        .status-overdue { 
            background: #ef4444; 
            color: white; 
            padding: 4px 8px; 
            border-radius: 12px; 
            font-size: 12px; 
            font-weight: 600;
            text-align: center;
        }
        .status-moved-out { 
            background: #6366f1; 
            color: white; 
            padding: 4px 8px; 
            border-radius: 12px; 
            font-size: 12px; 
            font-weight: 600;
            text-align: center;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(20px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }

        .slide-in {
            animation: slideIn 0.6s ease-out;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .bounce-in {
            animation: bounceIn 0.8s ease-out;
        }
        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3);
            }
            50% {
                opacity: 1;
                transform: scale(1.05);
            }
            70% {
                transform: scale(0.9);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-full">
    <div class="container mx-auto px-4 py-6">
        <!-- Header -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8 slide-in">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="bg-gradient-to-r from-purple-500 to-pink-500 rounded-2xl w-16 h-16 mr-4 flex items-center justify-center shadow-lg">
                        <span class="text-white text-2xl">üìä</span>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">
                            ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡πÅ‡∏ú‡∏á‡πÉ‡∏ô‡∏ï‡∏•‡∏≤‡∏î
                        </h1>
                        <p class="text-gray-600 text-base mt-1">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡πÅ‡∏ú‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û</p>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <button onclick="toggleDashboard()" 
                            class="bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white px-6 py-3 rounded-xl text-sm flex items-center shadow-lg transition-all duration-300 hover:scale-105">
                        <span class="mr-2 text-lg">üìà</span>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î
                    </button>
                    <button onclick="toggleView()" 
                            class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-6 py-3 rounded-xl text-sm flex items-center shadow-lg transition-all duration-300 hover:scale-105">
                        <span class="mr-2 text-lg">üìã</span>‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°
                    </button>
                </div>
            </div>
        </div>

        <!-- Dashboard -->
        <div id="dashboardView" class="mb-6">
            <!-- Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- Total Revenue Card -->
                <div class="bg-gradient-to-br from-emerald-400 via-emerald-500 to-emerald-600 rounded-2xl p-6 text-white shadow-2xl transform hover:scale-105 transition-all duration-300 bounce-in">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-emerald-100 text-sm font-medium mb-2">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</p>
                            <p id="totalRevenue" class="text-3xl font-bold">0 ‡∏ö‡∏≤‡∏ó</p>
                        </div>
                        <div class="bg-white bg-opacity-20 rounded-2xl p-4 backdrop-blur-sm">
                            <span class="text-3xl">üí∞</span>
                        </div>
                    </div>
                    <div class="mt-4 flex items-center">
                        <div class="w-full bg-emerald-300 bg-opacity-30 rounded-full h-2">
                            <div class="bg-white h-2 rounded-full" style="width: 75%"></div>
                        </div>
                    </div>
                </div>

                <!-- Total Stalls Card -->
                <div class="bg-gradient-to-br from-blue-400 via-blue-500 to-blue-600 rounded-2xl p-6 text-white shadow-2xl transform hover:scale-105 transition-all duration-300 bounce-in" style="animation-delay: 0.1s">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-blue-100 text-sm font-medium mb-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ú‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡πà‡∏≤</p>
                            <p id="totalStalls" class="text-3xl font-bold">0 ‡πÅ‡∏ú‡∏á</p>
                        </div>
                        <div class="bg-white bg-opacity-20 rounded-2xl p-4 backdrop-blur-sm">
                            <span class="text-3xl">üè™</span>
                        </div>
                    </div>
                    <div class="mt-4 flex items-center">
                        <div class="w-full bg-blue-300 bg-opacity-30 rounded-full h-2">
                            <div class="bg-white h-2 rounded-full" style="width: 60%"></div>
                        </div>
                    </div>
                </div>

                <!-- Expiring Soon Card -->
                <div class="bg-gradient-to-br from-amber-400 via-orange-500 to-orange-600 rounded-2xl p-6 text-white shadow-2xl transform hover:scale-105 transition-all duration-300 bounce-in" style="animation-delay: 0.2s">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-orange-100 text-sm font-medium mb-2">‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ (30 ‡∏ß‡∏±‡∏ô)</p>
                            <p id="expiringSoon" class="text-3xl font-bold">0 ‡∏™‡∏±‡∏ç‡∏ç‡∏≤</p>
                        </div>
                        <div class="bg-white bg-opacity-20 rounded-2xl p-4 backdrop-blur-sm pulse">
                            <span class="text-3xl">‚è∞</span>
                        </div>
                    </div>
                    <div class="mt-4 flex items-center">
                        <div class="w-full bg-orange-300 bg-opacity-30 rounded-full h-2">
                            <div class="bg-white h-2 rounded-full" style="width: 40%"></div>
                        </div>
                    </div>
                </div>

                <!-- Expired Card -->
                <div class="bg-gradient-to-br from-red-400 via-red-500 to-red-600 rounded-2xl p-6 text-white shadow-2xl transform hover:scale-105 transition-all duration-300 bounce-in" style="animation-delay: 0.3s">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-red-100 text-sm font-medium mb-2">‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß</p>
                            <p id="expiredContracts" class="text-3xl font-bold">0 ‡∏™‡∏±‡∏ç‡∏ç‡∏≤</p>
                        </div>
                        <div class="bg-white bg-opacity-20 rounded-2xl p-4 backdrop-blur-sm pulse">
                            <span class="text-3xl">üö®</span>
                        </div>
                    </div>
                    <div class="mt-4 flex items-center">
                        <div class="w-full bg-red-300 bg-opacity-30 rounded-full h-2">
                            <div class="bg-white h-2 rounded-full" style="width: 20%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts and Details -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <!-- Building Distribution -->
                <div class="bg-white rounded-xl shadow-lg p-8 fade-in">
                    <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
                        <div class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-xl p-3 mr-3">
                            <span class="text-white text-lg">üè¢</span>
                        </div>
                        ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£
                    </h3>
                    <div id="buildingChart" class="space-y-4">
                        <!-- Building distribution will be rendered here -->
                    </div>
                </div>

                <!-- Contract Status -->
                <div class="bg-white rounded-xl shadow-lg p-8 fade-in" style="animation-delay: 0.2s">
                    <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
                        <div class="bg-gradient-to-r from-green-500 to-teal-600 rounded-xl p-3 mr-3">
                            <span class="text-white text-lg">üìã</span>
                        </div>
                        ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏±‡∏ç‡∏ç‡∏≤
                    </h3>
                    <div id="statusChart" class="space-y-4">
                        <!-- Status distribution will be rendered here -->
                    </div>
                </div>
            </div>

            <!-- Expiring Contracts Table -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                        <span class="mr-2">‚ö†Ô∏è</span>‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°
                    </h3>
                    <div class="flex space-x-2">
                        <button onclick="filterExpiringContracts(7)" 
                                class="text-sm bg-red-100 hover:bg-red-200 text-red-800 px-3 py-1 rounded-lg">
                            7 ‡∏ß‡∏±‡∏ô
                        </button>
                        <button onclick="filterExpiringContracts(15)" 
                                class="text-sm bg-yellow-100 hover:bg-yellow-200 text-yellow-800 px-3 py-1 rounded-lg">
                            15 ‡∏ß‡∏±‡∏ô
                        </button>
                        <button onclick="filterExpiringContracts(30)" 
                                class="text-sm bg-orange-100 hover:bg-orange-200 text-orange-800 px-3 py-1 rounded-lg">
                            30 ‡∏ß‡∏±‡∏ô
                        </button>
                        <button onclick="filterExpiringContracts(0)" 
                                class="text-sm bg-gray-100 hover:bg-gray-200 text-gray-800 px-3 py-1 rounded-lg">
                            ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b">
                                <th class="text-left py-2 px-3 text-gray-800">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤</th>
                                <th class="text-left py-2 px-3 text-gray-800">‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£-‡πÅ‡∏ú‡∏á</th>
                                <th class="text-left py-2 px-3 text-gray-800">‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</th>
                                <th class="text-left py-2 px-3 text-gray-800">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                                <th class="text-left py-2 px-3 text-gray-800">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th>
                                <th class="text-left py-2 px-3 text-gray-800">‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody id="expiringContractsTable">
                            <!-- Expiring contracts will be rendered here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Add Rental Form -->
        <div id="formView" class="bg-white rounded-xl shadow-lg p-8 mb-8 fade-in">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                <div class="bg-gradient-to-r from-green-500 to-emerald-600 rounded-xl p-3 mr-3">
                    <span class="text-white text-lg">‚ûï</span>
                </div>
                ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡πÅ‡∏ú‡∏á
            </h2>
            <form id="rentalForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤</label>
                    <input type="text" id="tenantName" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£</label>
                    <select id="building" required 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£</option>
                        <option value="‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ A">‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ A</option>
                        <option value="‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ B">‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ B</option>
                        <option value="‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ C">‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ C</option>
                        <option value="‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ D">‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ D</option>
                        <option value="‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ E">‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ E</option>
                        <option value="‡πÇ‡∏ã‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á">‡πÇ‡∏ã‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÅ‡∏ú‡∏á</label>
                    <input type="text" id="stallNumber" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="‡πÄ‡∏ä‡πà‡∏ô 01, 02, 03">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                    <select id="productType" required 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            onchange="toggleCustomProductType()">
                        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</option>
                        <option value="‡∏ú‡∏±‡∏Å-‡∏ú‡∏•‡πÑ‡∏°‡πâ">‡∏ú‡∏±‡∏Å-‡∏ú‡∏•‡πÑ‡∏°‡πâ</option>
                        <option value="‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå">‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå</option>
                        <option value="‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏´‡πâ‡∏á">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏´‡πâ‡∏á</option>
                        <option value="‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∏‡∏á">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∏‡∏á</option>
                        <option value="‡∏Ç‡∏ô‡∏°-‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°">‡∏Ç‡∏ô‡∏°-‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</option>
                        <option value="‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤">‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤</option>
                        <option value="‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏ö‡πâ‡∏≤‡∏ô">‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏ö‡πâ‡∏≤‡∏ô</option>
                        <option value="‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏≥‡∏≠‡∏≤‡∏á">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏≥‡∏≠‡∏≤‡∏á</option>
                        <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏£‡∏∞‡∏ö‡∏∏)">‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏£‡∏∞‡∏ö‡∏∏)</option>
                    </select>
                    <input type="text" id="customProductType" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent mt-2 hidden"
                           placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤...">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                    <input type="tel" id="phoneNumber" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="08X-XXX-XXXX">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">‡∏Ñ‡πà‡∏≤‡∏•‡πá‡∏≠‡∏Ñ/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
                    <input type="number" id="lockFee" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="0">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
                    <input type="number" id="commonFee" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="0">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏±‡∏ç‡∏ç‡∏≤</label>
                    <input type="date" id="contractStartDate" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           onchange="calculateEndDate()">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏±‡∏ç‡∏ç‡∏≤</label>
                    <select id="contractDuration" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            onchange="toggleCustomDuration()">
                        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</option>
                        <option value="3m">3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                        <option value="6m">6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                        <option value="1y">1 ‡∏õ‡∏µ</option>
                        <option value="2y">2 ‡∏õ‡∏µ</option>
                        <option value="3y">3 ‡∏õ‡∏µ</option>
                        <option value="custom">‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏≠‡∏á</option>
                    </select>
                    <div id="customDurationContainer" class="mt-2 hidden">
                        <div class="grid grid-cols-2 gap-2">
                            <input type="number" id="customDurationValue" min="1" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô" onchange="calculateEndDate()">
                            <select id="customDurationUnit" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    onchange="calculateEndDate()">
                                <option value="">‡∏´‡∏ô‡πà‡∏ß‡∏¢</option>
                                <option value="days">‡∏ß‡∏±‡∏ô</option>
                                <option value="months">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                                <option value="years">‡∏õ‡∏µ</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤</label>
                    <input type="date" id="contractEndDate" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤</label>
                    <select id="paymentStatus" required 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
                        <option value="‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÅ‡∏•‡πâ‡∏ß">‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÅ‡∏•‡πâ‡∏ß</option>
                        <option value="‡∏£‡∏≠‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤">‡∏£‡∏≠‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤</option>
                        <option value="‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏">‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</option>
                        <option value="‡∏¢‡πâ‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß">‡∏¢‡πâ‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞</label>
                    <select id="paymentDate" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞</option>
                        <option value="‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô">‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</option>
                        <option value="‡∏£‡∏≤‡∏¢10‡∏ß‡∏±‡∏ô">‡∏£‡∏≤‡∏¢10‡∏ß‡∏±‡∏ô</option>
                        <option value="‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                    </select>
                </div>

                <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏Ñ‡πâ‡∏≥‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô -->
                <div class="md:col-span-2 lg:col-span-3">
                    <h3 class="text-md font-semibold text-gray-700 mb-3 flex items-center border-t pt-4">
                        <span class="mr-2">üë•</span>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏Ñ‡πâ‡∏≥‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô / ‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô
                    </h3>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ñ‡πâ‡∏≥‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô</label>
                    <input type="text" id="guarantorName" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡∏ú‡∏π‡πâ‡∏Ñ‡πâ‡∏≥‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ú‡∏π‡πâ‡∏Ñ‡πâ‡∏≥‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô</label>
                    <input type="tel" id="guarantorPhone" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="08X-XXX-XXXX">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå</label>
                    <select id="guarantorRelation" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå</option>
                        <option value="‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™">‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™</option>
                        <option value="‡∏ö‡∏¥‡∏î‡∏≤">‡∏ö‡∏¥‡∏î‡∏≤</option>
                        <option value="‡∏°‡∏≤‡∏£‡∏î‡∏≤">‡∏°‡∏≤‡∏£‡∏î‡∏≤</option>
                        <option value="‡∏ö‡∏∏‡∏ï‡∏£">‡∏ö‡∏∏‡∏ï‡∏£</option>
                        <option value="‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á">‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á</option>
                        <option value="‡∏ç‡∏≤‡∏ï‡∏¥">‡∏ç‡∏≤‡∏ï‡∏¥</option>
                        <option value="‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô</option>
                        <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                    </select>
                </div>

                <div class="md:col-span-2 lg:col-span-3">
                    <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ú‡∏π‡πâ‡∏Ñ‡πâ‡∏≥‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô</label>
                    <textarea id="guarantorAddress" rows="2" 
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                              placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ú‡∏π‡πâ‡∏Ñ‡πâ‡∏≥‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô..."></textarea>
                </div>

                <div class="md:col-span-2 lg:col-span-3">
                    <label class="block text-sm font-medium text-gray-700 mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                    <textarea id="notes" rows="2" 
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                              placeholder="‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."></textarea>
                </div>

                <div class="md:col-span-2 lg:col-span-3">
                    <button type="submit" 
                            class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-4 rounded-lg transition duration-200 flex items-center justify-center">
                        <span class="mr-2">üíæ</span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </button>
                </div>
            </form>
        </div>

        <!-- Quick Actions -->
        <div class="bg-white rounded-xl shadow-lg p-4 mb-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                <span class="mr-2">‚ö°</span>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏î‡πà‡∏ß‡∏ô
            </h3>
            
            <!-- Quick Stats -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                <div class="bg-gradient-to-r from-green-100 to-green-200 p-3 rounded-lg">
                    <div class="text-sm text-green-700">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
                    <div id="todayRevenue" class="text-lg font-bold text-green-800">0 ‡∏ö‡∏≤‡∏ó</div>
                </div>
                <div class="bg-gradient-to-r from-blue-100 to-blue-200 p-3 rounded-lg">
                    <div class="text-sm text-blue-700">‡πÅ‡∏ú‡∏á‡∏ß‡πà‡∏≤‡∏á</div>
                    <div id="emptyStalls" class="text-lg font-bold text-blue-800">0 ‡πÅ‡∏ú‡∏á</div>
                </div>
                <div class="bg-gradient-to-r from-yellow-100 to-yellow-200 p-3 rounded-lg">
                    <div class="text-sm text-yellow-700">‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</div>
                    <div id="needFollowUp" class="text-lg font-bold text-yellow-800">0 ‡∏£‡∏≤‡∏¢</div>
                </div>
                <div class="bg-gradient-to-r from-purple-100 to-purple-200 p-3 rounded-lg">
                    <div class="text-sm text-purple-700">‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
                    <div id="todayCollection" class="text-lg font-bold text-purple-800">0 ‡∏£‡∏≤‡∏¢</div>
                </div>
            </div>

            <!-- Search and Actions -->
            <div class="flex flex-col md:flex-row gap-4 mb-4">
                <div class="relative flex-1">
                    <input type="text" id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•..." 
                           class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <span class="absolute left-3 top-2.5 text-gray-400">üîç</span>
                </div>
                <div class="flex gap-2">
                    <button onclick="addNewRow()" 
                            class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center justify-center">
                        <span class="mr-2">‚ûï</span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß‡πÉ‡∏´‡∏°‡πà
                    </button>
                </div>
            </div>
            
            <!-- Data Management Buttons -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                <button onclick="exportData()" 
                        class="bg-green-500 hover:bg-green-600 text-white text-sm py-2 px-3 rounded-lg flex items-center justify-center transition duration-200">
                    <span class="mr-1">üì§</span>‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV
                </button>
                <button onclick="document.getElementById('importFile').click()" 
                        class="bg-blue-500 hover:bg-blue-600 text-white text-sm py-2 px-3 rounded-lg flex items-center justify-center transition duration-200">
                    <span class="mr-1">üì•</span>‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå
                </button>
                <button onclick="backupData()" 
                        class="bg-purple-500 hover:bg-purple-600 text-white text-sm py-2 px-3 rounded-lg flex items-center justify-center transition duration-200">
                    <span class="mr-1">üíæ</span>‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                </button>
                <button onclick="copyForGoogleSheets()" 
                        class="bg-green-500 hover:bg-green-600 text-white text-sm py-2 px-3 rounded-lg flex items-center justify-center transition duration-200">
                    <span class="mr-1">üìã</span>‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Sheets
                </button>
                <button onclick="showPasteFromSheetsModal()" 
                        class="bg-blue-500 hover:bg-blue-600 text-white text-sm py-2 px-3 rounded-lg flex items-center justify-center transition duration-200">
                    <span class="mr-1">üì•</span>‡∏ß‡∏≤‡∏á‡∏à‡∏≤‡∏Å Sheets
                </button>
                <button onclick="printReport()" 
                        class="bg-purple-500 hover:bg-purple-600 text-white text-sm py-2 px-3 rounded-lg flex items-center justify-center transition duration-200">
                    <span class="mr-1">üñ®Ô∏è</span>‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
                </button>
                <button onclick="clearAllData()" 
                        class="bg-red-500 hover:bg-red-600 text-white text-sm py-2 px-3 rounded-lg flex items-center justify-center transition duration-200">
                    <span class="mr-1">üóëÔ∏è</span>‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                </button>
            </div>
            
            <!-- Hidden file inputs -->
            <input type="file" id="importFile" accept=".csv,.json" style="display: none;" onchange="handleFileImport(event)">
        </div>

        <!-- Spreadsheet View -->
        <div id="spreadsheetView" class="bg-white rounded-xl shadow-lg p-6 fade-in">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-2xl font-bold text-gray-800 flex items-center">
                    <div class="bg-gradient-to-r from-blue-500 to-cyan-600 rounded-xl p-3 mr-3">
                        <span class="text-white text-lg">üìä</span>
                    </div>
                    ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡πÅ‡∏ú‡∏á
                </h3>
                <div class="flex items-center space-x-4">
                    <span id="recordCount" class="text-sm bg-green-100 text-green-800 px-3 py-1 rounded-full">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                    <div class="text-sm text-gray-600">
                        ‡∏£‡∏ß‡∏°: <span id="totalAmount" class="font-semibold text-green-600">0</span> ‡∏ö‡∏≤‡∏ó
                    </div>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="spreadsheet-table">
                    <thead>
                        <tr>
                            <th class="row-number">#</th>
                            <th style="min-width: 120px;">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤</th>
                            <th style="min-width: 80px;">‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£</th>
                            <th style="min-width: 80px;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÅ‡∏ú‡∏á</th>
                            <th style="min-width: 100px;">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                            <th style="min-width: 120px;">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</th>
                            <th style="min-width: 80px;">‡∏Ñ‡πà‡∏≤‡∏•‡πá‡∏≠‡∏Ñ</th>
                            <th style="min-width: 80px;">‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á</th>
                            <th style="min-width: 80px;">‡∏£‡∏ß‡∏°</th>
                            <th style="min-width: 100px;">‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏±‡∏ç‡∏ç‡∏≤</th>
                            <th style="min-width: 80px;">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</th>
                            <th style="min-width: 100px;">‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤</th>
                            <th style="min-width: 80px;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                            <th style="min-width: 120px;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤</th>
                            <th style="min-width: 120px;">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞</th>
                            <th style="min-width: 120px;">‡∏ú‡∏π‡πâ‡∏Ñ‡πâ‡∏≥‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô</th>
                            <th style="min-width: 120px;">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ú‡∏π‡πâ‡∏Ñ‡πâ‡∏≥‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô</th>
                            <th style="min-width: 150px;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                            <th style="min-width: 80px;">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody id="spreadsheetBody">
                        <tr>
                            <td colspan="19" class="text-center text-gray-500 py-8">
                                <div>
                                    <span class="text-4xl mb-2 block">üìä</span>
                                    <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡πÅ‡∏ú‡∏á</p>
                                    <p class="text-sm">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÇ‡∏î‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏Å</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Success/Error Message -->
        <div id="successMessage" class="fixed top-4 left-4 right-4 bg-green-500 text-white p-4 rounded-lg shadow-lg transform -translate-y-full opacity-0 transition-all duration-300 z-50">
            <div class="flex items-center">
                <span class="mr-2">‚úÖ</span>
                <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!</span>
            </div>
        </div>

        <!-- Paste from Sheets Modal -->
        <div id="pasteFromSheetsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-xl p-6 mx-4 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <div class="mb-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                            <span class="mr-2">üì•</span>‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets
                        </h3>
                        <button onclick="closePasteFromSheetsModal()" class="text-gray-500 hover:text-gray-700 text-xl">
                            ‚úï
                        </button>
                    </div>
                    <p class="text-gray-600 text-sm mb-4">‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Google Sheets ‡∏•‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á</p>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets:</label>
                    <textarea id="sheetsDataInput" 
                              class="w-full h-64 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm font-mono"
                              placeholder="‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Google Sheets ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...&#10;&#10;‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:&#10;‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤	‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£	‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÅ‡∏ú‡∏á	‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤&#10;‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢	‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ A	01	‡∏ú‡∏±‡∏Å-‡∏ú‡∏•‡πÑ‡∏°‡πâ&#10;‡∏ô‡∏≤‡∏á‡∏™‡∏°‡∏´‡∏ç‡∏¥‡∏á	‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ B	02	‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå"></textarea>
                </div>

                <div class="mb-4">
                    <div class="flex items-center space-x-4">
                        <label class="flex items-center">
                            <input type="radio" name="importMode" value="replace" checked class="mr-2">
                            <span class="text-sm text-gray-700">‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="importMode" value="append" class="mr-2">
                            <span class="text-sm text-gray-700">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°</span>
                        </label>
                    </div>
                </div>

                <div class="flex space-x-3">
                    <button onclick="importFromSheets()" 
                            class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg flex items-center justify-center">
                        <span class="mr-2">üì•</span>‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </button>
                    <button onclick="closePasteFromSheetsModal()" 
                            class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-2 px-4 rounded-lg">
                        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                </div>
            </div>
        </div>

        <!-- Confirmation Modal -->
        <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-xl p-6 mx-4 max-w-sm w-full">
                <div class="text-center mb-4">
                    <span class="text-4xl mb-2 block">‚ö†Ô∏è</span>
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</h3>
                    <p id="confirmText" class="text-gray-600 text-sm"></p>
                </div>
                <div class="flex space-x-3">
                    <button id="confirmYes" class="flex-1 bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-lg">
                        ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
                    </button>
                    <button id="confirmNo" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-2 px-4 rounded-lg">
                        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let rentals = JSON.parse(localStorage.getItem('marketRentals')) || [];
        let nextId = parseInt(localStorage.getItem('nextRentalId')) || 1;
        let currentView = 'spreadsheet';
        let showDashboard = true;

        function saveToStorage() {
            localStorage.setItem('marketRentals', JSON.stringify(rentals));
            localStorage.setItem('nextRentalId', nextId.toString());
        }

        function getDaysUntilExpiry(endDate) {
            if (!endDate) return null;
            const today = new Date();
            const expiry = new Date(endDate);
            const diffTime = expiry - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }

        function getDurationText(rental) {
            if (!rental.contractDuration) return '';
            
            switch(rental.contractDuration) {
                case '3m': return '3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô';
                case '6m': return '6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô';
                case '1y': return '1 ‡∏õ‡∏µ';
                case '2y': return '2 ‡∏õ‡∏µ';
                case '3y': return '3 ‡∏õ‡∏µ';
                case 'custom': 
                    if (rental.customDurationValue && rental.customDurationUnit) {
                        const unitText = {
                            'days': '‡∏ß‡∏±‡∏ô',
                            'months': '‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', 
                            'years': '‡∏õ‡∏µ'
                        };
                        return `${rental.customDurationValue} ${unitText[rental.customDurationUnit] || rental.customDurationUnit}`;
                    }
                    return '‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á';
                default: return '';
            }
        }

        function toggleCustomProductType() {
            const productTypeSelect = document.getElementById('productType');
            const customProductTypeInput = document.getElementById('customProductType');
            
            if (productTypeSelect.value === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏£‡∏∞‡∏ö‡∏∏)') {
                customProductTypeInput.classList.remove('hidden');
                customProductTypeInput.required = true;
                customProductTypeInput.focus();
            } else {
                customProductTypeInput.classList.add('hidden');
                customProductTypeInput.required = false;
                customProductTypeInput.value = '';
            }
        }

        function toggleCustomDuration() {
            const duration = document.getElementById('contractDuration').value;
            const customContainer = document.getElementById('customDurationContainer');
            const customValue = document.getElementById('customDurationValue');
            const customUnit = document.getElementById('customDurationUnit');
            
            if (duration === 'custom') {
                customContainer.classList.remove('hidden');
                customValue.required = true;
                customUnit.required = true;
                customValue.focus();
            } else {
                customContainer.classList.add('hidden');
                customValue.required = false;
                customUnit.required = false;
                customValue.value = '';
                customUnit.value = '';
            }
            
            calculateEndDate();
        }

        function calculateEndDate() {
            const startDate = document.getElementById('contractStartDate').value;
            const duration = document.getElementById('contractDuration').value;
            const customValue = document.getElementById('customDurationValue').value;
            const customUnit = document.getElementById('customDurationUnit').value;
            const endDateInput = document.getElementById('contractEndDate');
            
            if (!startDate) {
                return;
            }
            
            const start = new Date(startDate);
            let endDate = new Date(start);
            
            if (duration === 'custom') {
                if (!customValue || !customUnit) {
                    endDateInput.disabled = false;
                    return;
                }
                
                const value = parseInt(customValue);
                switch(customUnit) {
                    case 'days':
                        endDate.setDate(endDate.getDate() + value);
                        break;
                    case 'months':
                        endDate.setMonth(endDate.getMonth() + value);
                        break;
                    case 'years':
                        endDate.setFullYear(endDate.getFullYear() + value);
                        break;
                }
                endDate.setDate(endDate.getDate() - 1);
            } else if (duration) {
                switch(duration) {
                    case '3m':
                        endDate.setMonth(endDate.getMonth() + 3);
                        break;
                    case '6m':
                        endDate.setMonth(endDate.getMonth() + 6);
                        break;
                    case '1y':
                        endDate.setFullYear(endDate.getFullYear() + 1);
                        break;
                    case '2y':
                        endDate.setFullYear(endDate.getFullYear() + 2);
                        break;
                    case '3y':
                        endDate.setFullYear(endDate.getFullYear() + 3);
                        break;
                }
                endDate.setDate(endDate.getDate() - 1);
            } else {
                endDateInput.disabled = false;
                return;
            }
            
            endDateInput.value = endDate.toISOString().split('T')[0];
            endDateInput.disabled = true;
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('th-TH').format(amount);
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            return new Date(dateString).toLocaleDateString('th-TH');
        }

        function getStatusClass(status) {
            switch(status) {
                case '‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÅ‡∏•‡πâ‡∏ß': return 'status-paid';
                case '‡∏£‡∏≠‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤': return 'status-pending';
                case '‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏': return 'status-overdue';
                case '‡∏¢‡πâ‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß': return 'status-moved-out';
                default: return '';
            }
        }

        function showMessage(text, type = 'success') {
            const message = document.getElementById('successMessage');
            const messageText = message.querySelector('span:last-child');
            const messageIcon = message.querySelector('span:first-child');
            
            messageText.textContent = text;
            
            message.className = 'fixed top-4 left-4 right-4 p-4 rounded-lg shadow-lg transform -translate-y-full opacity-0 transition-all duration-300 z-50';
            
            if (type === 'success') {
                message.classList.add('bg-green-500', 'text-white');
                messageIcon.textContent = '‚úÖ';
            } else if (type === 'error') {
                message.classList.add('bg-red-500', 'text-white');
                messageIcon.textContent = '‚ùå';
            } else if (type === 'warning') {
                message.classList.add('bg-yellow-500', 'text-white');
                messageIcon.textContent = '‚ö†Ô∏è';
            }
            
            message.style.transform = 'translateY(0)';
            message.style.opacity = '1';
            setTimeout(() => {
                message.style.transform = 'translateY(-100%)';
                message.style.opacity = '0';
            }, 3000);
        }

        function showConfirmModal(text, onConfirm) {
            const modal = document.getElementById('confirmModal');
            const confirmText = document.getElementById('confirmText');
            const confirmYes = document.getElementById('confirmYes');
            const confirmNo = document.getElementById('confirmNo');
            
            confirmText.textContent = text;
            modal.classList.remove('hidden');
            
            confirmYes.onclick = () => {
                modal.classList.add('hidden');
                onConfirm();
            };
            
            confirmNo.onclick = () => {
                modal.classList.add('hidden');
            };
        }

        function toggleView() {
            const formView = document.getElementById('formView');
            const viewToggle = document.querySelector('button[onclick="toggleView()"]');
            
            if (currentView === 'spreadsheet') {
                currentView = 'form';
                formView.style.display = 'block';
                viewToggle.innerHTML = '<span class="mr-2">üìä</span>‡∏ï‡∏≤‡∏£‡∏≤‡∏á';
            } else {
                currentView = 'spreadsheet';
                formView.style.display = 'none';
                viewToggle.innerHTML = '<span class="mr-2">üìã</span>‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°';
            }
        }

        function toggleDashboard() {
            const dashboardView = document.getElementById('dashboardView');
            const dashboardToggle = document.querySelector('button[onclick="toggleDashboard()"]');
            
            showDashboard = !showDashboard;
            
            if (showDashboard) {
                dashboardView.style.display = 'block';
                dashboardToggle.innerHTML = '<span class="mr-2">üìä</span>‡∏ã‡πà‡∏≠‡∏ô‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î';
                updateDashboard();
            } else {
                dashboardView.style.display = 'none';
                dashboardToggle.innerHTML = '<span class="mr-2">üìà</span>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î';
            }
        }

        function updateDashboard() {
            if (!showDashboard) return;
            
            const stats = calculateStatistics();
            
            document.getElementById('totalRevenue').textContent = formatCurrency(stats.totalRevenue) + ' ‡∏ö‡∏≤‡∏ó';
            document.getElementById('totalStalls').textContent = stats.totalStalls + ' ‡πÅ‡∏ú‡∏á';
            document.getElementById('expiringSoon').textContent = stats.expiringSoon + ' ‡∏™‡∏±‡∏ç‡∏ç‡∏≤';
            document.getElementById('expiredContracts').textContent = stats.expired + ' ‡∏™‡∏±‡∏ç‡∏ç‡∏≤';
            
            renderBuildingChart(stats.buildingDistribution);
            renderStatusChart(stats.statusDistribution);
            renderExpiringContractsTable();
        }

        function calculateStatistics() {
            const now = new Date();
            const stats = {
                totalRevenue: 0,
                totalStalls: rentals.length,
                expiringSoon: 0,
                expired: 0,
                buildingDistribution: {},
                statusDistribution: {}
            };

            rentals.forEach(rental => {
                stats.totalRevenue += (parseFloat(rental.lockFee) || 0) + (parseFloat(rental.commonFee) || 0);
                
                if (rental.contractEndDate) {
                    const daysLeft = getDaysUntilExpiry(rental.contractEndDate);
                    if (daysLeft !== null) {
                        if (daysLeft <= 0) {
                            stats.expired++;
                        } else if (daysLeft <= 30) {
                            stats.expiringSoon++;
                        }
                    }
                }
                
                const building = rental.building || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                stats.buildingDistribution[building] = (stats.buildingDistribution[building] || 0) + 1;
                
                const status = rental.paymentStatus || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                stats.statusDistribution[status] = (stats.statusDistribution[status] || 0) + 1;
            });

            return stats;
        }

        function renderBuildingChart(distribution) {
            const chartContainer = document.getElementById('buildingChart');
            const total = Object.values(distribution).reduce((sum, count) => sum + count, 0);
            
            if (total === 0) {
                chartContainer.innerHTML = '<p class="text-gray-500 text-center py-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
                return;
            }

            const colors = ['bg-blue-500', 'bg-green-500', 'bg-yellow-500', 'bg-purple-500', 'bg-pink-500', 'bg-indigo-500'];
            let colorIndex = 0;

            chartContainer.innerHTML = Object.entries(distribution)
                .sort(([,a], [,b]) => b - a)
                .map(([building, count]) => {
                    const percentage = ((count / total) * 100).toFixed(1);
                    const color = colors[colorIndex % colors.length];
                    colorIndex++;
                    
                    return `
                        <div class="flex items-center justify-between py-2">
                            <div class="flex items-center flex-1">
                                <div class="w-4 h-4 ${color} rounded mr-3"></div>
                                <span class="text-sm text-gray-700">${building}</span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-24 bg-gray-200 rounded-full h-2 mr-3">
                                    <div class="${color} h-2 rounded-full" style="width: ${percentage}%"></div>
                                </div>
                                <span class="text-sm font-semibold text-gray-700 w-12 text-right">${count}</span>
                            </div>
                        </div>
                    `;
                }).join('');
        }

        function renderStatusChart(distribution) {
            const chartContainer = document.getElementById('statusChart');
            const total = Object.values(distribution).reduce((sum, count) => sum + count, 0);
            
            if (total === 0) {
                chartContainer.innerHTML = '<p class="text-gray-500 text-center py-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
                return;
            }

            const statusColors = {
                '‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÅ‡∏•‡πâ‡∏ß': 'bg-green-500',
                '‡∏£‡∏≠‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤': 'bg-yellow-500',
                '‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏': 'bg-red-500',
                '‡∏¢‡πâ‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß': 'bg-blue-500',
                '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏': 'bg-gray-500'
            };

            chartContainer.innerHTML = Object.entries(distribution)
                .sort(([,a], [,b]) => b - a)
                .map(([status, count]) => {
                    const percentage = ((count / total) * 100).toFixed(1);
                    const color = statusColors[status] || 'bg-gray-500';
                    
                    return `
                        <div class="flex items-center justify-between py-2">
                            <div class="flex items-center flex-1">
                                <div class="w-4 h-4 ${color} rounded mr-3"></div>
                                <span class="text-sm text-gray-700">${status}</span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-24 bg-gray-200 rounded-full h-2 mr-3">
                                    <div class="${color} h-2 rounded-full" style="width: ${percentage}%"></div>
                                </div>
                                <span class="text-sm font-semibold text-gray-700 w-12 text-right">${count}</span>
                            </div>
                        </div>
                    `;
                }).join('');
        }

        function renderExpiringContractsTable(daysFilter = 30) {
            const tableBody = document.getElementById('expiringContractsTable');
            const now = new Date();
            
            const expiringContracts = rentals
                .filter(rental => {
                    if (!rental.contractEndDate) return false;
                    const daysLeft = getDaysUntilExpiry(rental.contractEndDate);
                    if (daysFilter === 0) return daysLeft !== null;
                    return daysLeft !== null && daysLeft <= daysFilter && daysLeft >= 0;
                })
                .sort((a, b) => {
                    const daysA = getDaysUntilExpiry(a.contractEndDate);
                    const daysB = getDaysUntilExpiry(b.contractEndDate);
                    return daysA - daysB;
                });

            if (expiringContracts.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-4 text-gray-500">
                            ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°${daysFilter > 0 ? ` (${daysFilter} ‡∏ß‡∏±‡∏ô)` : ''}
                        </td>
                    </tr>
                `;
                return;
            }

            tableBody.innerHTML = expiringContracts.map(rental => {
                const daysLeft = getDaysUntilExpiry(rental.contractEndDate);
                const urgencyClass = daysLeft <= 7 ? 'text-red-600 font-bold' : 
                                   daysLeft <= 15 ? 'text-yellow-600 font-semibold' : 
                                   'text-orange-600';
                
                return `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="py-2 px-3 text-gray-700">${rental.tenantName}</td>
                        <td class="py-2 px-3 text-gray-700">${rental.building} - ${rental.stallNumber}</td>
                        <td class="py-2 px-3 text-gray-700">${formatDate(rental.contractEndDate)}</td>
                        <td class="py-2 px-3 ${urgencyClass}">${daysLeft} ‡∏ß‡∏±‡∏ô</td>
                        <td class="py-2 px-3">
                            ${rental.phone ? `<a href="tel:${rental.phone}" class="text-blue-600 hover:underline">${rental.phone}</a>` : '-'}
                        </td>
                        <td class="py-2 px-3">
                            <div class="flex space-x-1">
                                <button onclick="callTenant('${rental.phone}')" 
                                        class="text-green-600 hover:text-green-800 p-1 rounded" 
                                        title="‡πÇ‡∏ó‡∏£‡∏´‡∏≤" ${!rental.phone ? 'disabled' : ''}>
                                    üìû
                                </button>
                                <button onclick="editRental(${rental.id})" 
                                        class="text-blue-600 hover:text-blue-800 p-1 rounded" 
                                        title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">
                                    ‚úèÔ∏è
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function filterExpiringContracts(days) {
            renderExpiringContractsTable(days);
        }

        function callTenant(phone) {
            if (phone) {
                window.open(`tel:${phone}`, '_self');
            }
        }

        function editRental(id) {
            const rental = rentals.find(r => r.id === id);
            if (!rental) return;
            
            document.getElementById('tenantName').value = rental.tenantName;
            document.getElementById('building').value = rental.building || '';
            document.getElementById('stallNumber').value = rental.stallNumber;
            
            const productTypeSelect = document.getElementById('productType');
            const customProductTypeInput = document.getElementById('customProductType');
            const standardTypes = ['‡∏ú‡∏±‡∏Å-‡∏ú‡∏•‡πÑ‡∏°‡πâ', '‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå', '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏´‡πâ‡∏á', '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∏‡∏á', '‡∏Ç‡∏ô‡∏°-‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°', '‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤', '‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏ö‡πâ‡∏≤‡∏ô', '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏≥‡∏≠‡∏≤‡∏á'];
            
            if (standardTypes.includes(rental.productType)) {
                productTypeSelect.value = rental.productType;
                customProductTypeInput.classList.add('hidden');
                customProductTypeInput.required = false;
            } else {
                productTypeSelect.value = '‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏£‡∏∞‡∏ö‡∏∏)';
                customProductTypeInput.value = rental.productType;
                customProductTypeInput.classList.remove('hidden');
                customProductTypeInput.required = true;
            }
            
            document.getElementById('phoneNumber').value = rental.phone || '';
            document.getElementById('lockFee').value = rental.lockFee || 0;
            document.getElementById('commonFee').value = rental.commonFee || 0;
            document.getElementById('contractStartDate').value = rental.contractStartDate;
            document.getElementById('contractEndDate').value = rental.contractEndDate;
            document.getElementById('paymentStatus').value = rental.paymentStatus;
            document.getElementById('paymentDate').value = rental.paymentDate || '';
            document.getElementById('guarantorName').value = rental.guarantorName || '';
            document.getElementById('guarantorPhone').value = rental.guarantorPhone || '';
            document.getElementById('guarantorRelation').value = rental.guarantorRelation || '';
            document.getElementById('guarantorAddress').value = rental.guarantorAddress || '';
            document.getElementById('notes').value = rental.notes || '';
            
            const formView = document.getElementById('formView');
            formView.style.display = 'block';
            currentView = 'form';
            document.querySelector('button[onclick="toggleView()"]').innerHTML = '<span class="mr-2">üìä</span>‡∏ï‡∏≤‡∏£‡∏≤‡∏á';
            
            formView.scrollIntoView({ behavior: 'smooth' });
            
            rentals = rentals.filter(r => r.id !== id);
            saveToStorage();
            updateDashboard();
            renderSpreadsheet();
            
            showMessage('‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡∏∞‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç', 'warning');
        }

        function renderSpreadsheet(rentalsToRender = rentals) {
            const spreadsheetBody = document.getElementById('spreadsheetBody');
            const recordCount = document.getElementById('recordCount');
            const totalAmount = document.getElementById('totalAmount');
            
            const sortedRentals = [...rentalsToRender].sort((a, b) => {
                const buildingA = a.building || '';
                const buildingB = b.building || '';
                if (buildingA !== buildingB) {
                    return buildingA.localeCompare(buildingB, 'th');
                }
                
                const stallA = a.stallNumber || '';
                const stallB = b.stallNumber || '';
                
                const numA = parseInt(stallA);
                const numB = parseInt(stallB);
                
                if (!isNaN(numA) && !isNaN(numB)) {
                    return numA - numB;
                }
                
                return stallA.localeCompare(stallB, 'th');
            });
            
            recordCount.textContent = `${sortedRentals.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
            
            const total = sortedRentals.reduce((sum, rental) => sum + (parseFloat(rental.lockFee) || 0) + (parseFloat(rental.commonFee) || 0), 0);
            totalAmount.textContent = formatCurrency(total);

            if (sortedRentals.length === 0) {
                spreadsheetBody.innerHTML = `
                    <tr>
                        <td colspan="19" class="text-center text-gray-500 py-8">
                            <div>
                                <span class="text-4xl mb-2 block">üìä</span>
                                <p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡πÅ‡∏ú‡∏á</p>
                                <p class="text-sm">‡∏•‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏≥‡∏≠‡∏∑‡πà‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            spreadsheetBody.innerHTML = sortedRentals.map((rental, index) => {
                const daysLeft = getDaysUntilExpiry(rental.contractEndDate);
                const daysLeftText = daysLeft !== null ? 
                    (daysLeft <= 0 ? '‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß' : `${daysLeft} ‡∏ß‡∏±‡∏ô`) : 
                    '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                
                return `
                    <tr class="fade-in">
                        <td class="row-number">${index + 1}</td>
                        <td class="editable-cell" onclick="editCell(${rental.id}, 'tenantName', this)">${rental.tenantName}</td>
                        <td class="editable-cell" onclick="editCell(${rental.id}, 'building', this)">${rental.building || ''}</td>
                        <td class="editable-cell" onclick="editCell(${rental.id}, 'stallNumber', this)">${rental.stallNumber}</td>
                        <td class="editable-cell" onclick="editCell(${rental.id}, 'productType', this)">${rental.productType}</td>
                        <td class="editable-cell" onclick="editCell(${rental.id}, 'phone', this)">
                            ${rental.phone ? `<a href="tel:${rental.phone}" class="text-blue-600 hover:underline">${rental.phone}</a>` : ''}
                        </td>
                        <td class="editable-cell text-right" onclick="editCell(${rental.id}, 'lockFee', this)">${formatCurrency(rental.lockFee || 0)}</td>
                        <td class="editable-cell text-right" onclick="editCell(${rental.id}, 'commonFee', this)">${formatCurrency(rental.commonFee || 0)}</td>
                        <td class="text-right font-semibold text-green-600">${formatCurrency((rental.lockFee || 0) + (rental.commonFee || 0))}</td>
                        <td class="editable-cell" onclick="editCell(${rental.id}, 'contractStartDate', this)">${formatDate(rental.contractStartDate)}</td>
                        <td class="text-center">${getDurationText(rental)}</td>
                        <td class="editable-cell" onclick="editCell(${rental.id}, 'contractEndDate', this)">${formatDate(rental.contractEndDate)}</td>
                        <td class="text-center ${daysLeft !== null && daysLeft <= 7 ? 'text-red-600 font-bold' : daysLeft !== null && daysLeft <= 15 ? 'text-yellow-600 font-semibold' : ''}">${daysLeftText}</td>
                        <td class="editable-cell ${getStatusClass(rental.paymentStatus)}" onclick="editCell(${rental.id}, 'paymentStatus', this)">${rental.paymentStatus}</td>
                        <td class="editable-cell" onclick="editCell(${rental.id}, 'paymentDate', this)">${rental.paymentDate || ''}</td>
                        <td class="editable-cell" onclick="editCell(${rental.id}, 'guarantorName', this)">${rental.guarantorName || ''}</td>
                        <td class="editable-cell" onclick="editCell(${rental.id}, 'guarantorPhone', this)">
                            ${rental.guarantorPhone ? `<a href="tel:${rental.guarantorPhone}" class="text-blue-600 hover:underline">${rental.guarantorPhone}</a>` : ''}
                        </td>
                        <td class="editable-cell" onclick="editCell(${rental.id}, 'notes', this)">${rental.notes || ''}</td>
                        <td class="text-center">
                            <button onclick="deleteRental(${rental.id})" 
                                    class="text-red-500 hover:text-red-700 p-1 rounded" title="‡∏•‡∏ö">
                                üóëÔ∏è
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function editCell(id, field, cellElement) {
            const rental = rentals.find(r => r.id === id);
            if (!rental) return;
            
            const currentValue = rental[field] || '';
            const originalContent = cellElement.innerHTML;
            
            let inputElement;
            if (field === 'building') {
                inputElement = document.createElement('select');
                inputElement.className = 'cell-input';
                inputElement.innerHTML = `
                    <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£</option>
                    <option value="‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ A" ${currentValue === '‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ A' ? 'selected' : ''}>‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ A</option>
                    <option value="‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ B" ${currentValue === '‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ B' ? 'selected' : ''}>‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ B</option>
                    <option value="‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ C" ${currentValue === '‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ C' ? 'selected' : ''}>‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ C</option>
                    <option value="‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ D" ${currentValue === '‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ D' ? 'selected' : ''}>‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ D</option>
                    <option value="‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ E" ${currentValue === '‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ E' ? 'selected' : ''}>‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ E</option>
                    <option value="‡πÇ‡∏ã‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á" ${currentValue === '‡πÇ‡∏ã‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á' ? 'selected' : ''}>‡πÇ‡∏ã‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á</option>
                `;
            } else if (field === 'productType') {
                inputElement = document.createElement('select');
                inputElement.className = 'cell-input';
                inputElement.innerHTML = `
                    <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</option>
                    <option value="‡∏ú‡∏±‡∏Å-‡∏ú‡∏•‡πÑ‡∏°‡πâ" ${currentValue === '‡∏ú‡∏±‡∏Å-‡∏ú‡∏•‡πÑ‡∏°‡πâ' ? 'selected' : ''}>‡∏ú‡∏±‡∏Å-‡∏ú‡∏•‡πÑ‡∏°‡πâ</option>
                    <option value="‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå" ${currentValue === '‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå' ? 'selected' : ''}>‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå</option>
                    <option value="‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏´‡πâ‡∏á" ${currentValue === '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏´‡πâ‡∏á' ? 'selected' : ''}>‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏´‡πâ‡∏á</option>
                    <option value="‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∏‡∏á" ${currentValue === '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∏‡∏á' ? 'selected' : ''}>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∏‡∏á</option>
                    <option value="‡∏Ç‡∏ô‡∏°-‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°" ${currentValue === '‡∏Ç‡∏ô‡∏°-‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°' ? 'selected' : ''}>‡∏Ç‡∏ô‡∏°-‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</option>
                    <option value="‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤" ${currentValue === '‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤' ? 'selected' : ''}>‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤</option>
                    <option value="‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏ö‡πâ‡∏≤‡∏ô" ${currentValue === '‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏ö‡πâ‡∏≤‡∏ô' ? 'selected' : ''}>‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏ö‡πâ‡∏≤‡∏ô</option>
                    <option value="‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏≥‡∏≠‡∏≤‡∏á" ${currentValue === '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏≥‡∏≠‡∏≤‡∏á' ? 'selected' : ''}>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏≥‡∏≠‡∏≤‡∏á</option>
                    <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏£‡∏∞‡∏ö‡∏∏)" ${!['‡∏ú‡∏±‡∏Å-‡∏ú‡∏•‡πÑ‡∏°‡πâ', '‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå', '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏´‡πâ‡∏á', '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∏‡∏á', '‡∏Ç‡∏ô‡∏°-‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°', '‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤', '‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏ö‡πâ‡∏≤‡∏ô', '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏≥‡∏≠‡∏≤‡∏á'].includes(currentValue) && currentValue ? 'selected' : ''}>‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏£‡∏∞‡∏ö‡∏∏)</option>
                `;
            } else if (field === 'paymentStatus') {
                inputElement = document.createElement('select');
                inputElement.className = 'cell-input';
                inputElement.innerHTML = `
                    <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
                    <option value="‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÅ‡∏•‡πâ‡∏ß" ${currentValue === '‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÅ‡∏•‡πâ‡∏ß' ? 'selected' : ''}>‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÅ‡∏•‡πâ‡∏ß</option>
                    <option value="‡∏£‡∏≠‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤" ${currentValue === '‡∏£‡∏≠‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤' ? 'selected' : ''}>‡∏£‡∏≠‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤</option>
                    <option value="‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏" ${currentValue === '‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏' ? 'selected' : ''}>‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</option>
                    <option value="‡∏¢‡πâ‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß" ${currentValue === '‡∏¢‡πâ‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß' ? 'selected' : ''}>‡∏¢‡πâ‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß</option>
                `;
            } else if (field === 'lockFee' || field === 'commonFee') {
                inputElement = document.createElement('input');
                inputElement.type = 'number';
                inputElement.className = 'cell-input';
                inputElement.value = currentValue;
            } else if (field === 'contractStartDate' || field === 'contractEndDate') {
                inputElement = document.createElement('input');
                inputElement.type = 'date';
                inputElement.className = 'cell-input';
                inputElement.value = currentValue;
            } else if (field === 'paymentDate') {
                inputElement = document.createElement('select');
                inputElement.className = 'cell-input';
                inputElement.innerHTML = `
                    <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞</option>
                    <option value="‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô" ${currentValue === '‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô' ? 'selected' : ''}>‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</option>
                    <option value="‡∏£‡∏≤‡∏¢10‡∏ß‡∏±‡∏ô" ${currentValue === '‡∏£‡∏≤‡∏¢10‡∏ß‡∏±‡∏ô' ? 'selected' : ''}>‡∏£‡∏≤‡∏¢10‡∏ß‡∏±‡∏ô</option>
                    <option value="‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô" ${currentValue === '‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô' ? 'selected' : ''}>‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                `;
            } else {
                inputElement = document.createElement('input');
                inputElement.type = 'text';
                inputElement.className = 'cell-input';
                inputElement.value = currentValue;
            }
            
            cellElement.innerHTML = '';
            cellElement.appendChild(inputElement);
            inputElement.focus();
            
            function saveEdit() {
                const newValue = inputElement.value;
                rental[field] = newValue;
                saveToStorage();
                renderSpreadsheet();
                updateDashboard();
                showMessage('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!', 'success');
            }
            
            function cancelEdit() {
                cellElement.innerHTML = originalContent;
            }
            
            inputElement.addEventListener('blur', saveEdit);
            inputElement.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    saveEdit();
                } else if (e.key === 'Escape') {
                    cancelEdit();
                }
            });
        }

        function deleteRental(id) {
            showConfirmModal(
                '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
                () => {
                    rentals = rentals.filter(rental => rental.id !== id);
                    saveToStorage();
                    renderSpreadsheet();
                    updateDashboard();
                    showMessage('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!', 'success');
                }
            );
        }

        function addNewRow() {
            const newRental = {
                id: nextId++,
                tenantName: '',
                building: '',
                stallNumber: '',
                productType: '',
                phone: '',
                lockFee: 0,
                commonFee: 0,
                contractStartDate: '',
                contractEndDate: '',
                paymentStatus: '',
                paymentDate: '',
                guarantorName: '',
                guarantorPhone: '',
                guarantorRelation: '',
                guarantorAddress: '',
                notes: '',
                createdAt: new Date().toISOString()
            };
            
            rentals.unshift(newRental);
            saveToStorage();
            renderSpreadsheet();
            updateDashboard();
            showMessage('‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!', 'success');
        }

        function exportData() {
            if (rentals.length === 0) {
                showMessage('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å', 'warning');
                return;
            }

            const headers = ['‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤', '‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£', '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÅ‡∏ú‡∏á', '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå', '‡∏Ñ‡πà‡∏≤‡∏•‡πá‡∏≠‡∏Ñ', '‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á', '‡∏£‡∏ß‡∏°', '‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏±‡∏ç‡∏ç‡∏≤', '‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤', '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞', '‡∏ú‡∏π‡πâ‡∏Ñ‡πâ‡∏≥‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô', '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ú‡∏π‡πâ‡∏Ñ‡πâ‡∏≥‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô', '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ú‡∏π‡πâ‡∏Ñ‡πâ‡∏≥‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô', '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏'];
            const csvContent = [
                headers.join(','),
                ...rentals.map(rental => {
                    const daysLeft = getDaysUntilExpiry(rental.contractEndDate);
                    const daysLeftText = daysLeft !== null ? 
                        (daysLeft <= 0 ? '‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß' : `${daysLeft} ‡∏ß‡∏±‡∏ô`) : 
                        '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                    
                    return [
                        `"${rental.tenantName}"`,
                        `"${rental.building || ''}"`,
                        `"${rental.stallNumber}"`,
                        `"${rental.productType}"`,
                        `"${rental.phone || ''}"`,
                        `"${rental.lockFee || 0}"`,
                        `"${rental.commonFee || 0}"`,
                        `"${(rental.lockFee || 0) + (rental.commonFee || 0)}"`,
                        `"${formatDate(rental.contractStartDate)}"`,
                        `"${formatDate(rental.contractEndDate)}"`,
                        `"${daysLeftText}"`,
                        `"${rental.paymentStatus || ''}"`,
                        `"${rental.paymentDate || ''}"`,
                        `"${rental.guarantorName || ''}"`,
                        `"${rental.guarantorPhone || ''}"`,
                        `"${rental.guarantorRelation || ''}"`,
                        `"${rental.guarantorAddress || ''}"`,
                        `"${rental.notes || ''}"`
                    ].join(',');
                })
            ].join('\n');

            const encoder = new TextEncoder();
            const utf8Data = encoder.encode('\ufeff' + csvContent);
            const blob = new Blob([utf8Data], { type: 'text/csv;charset=utf-8;' });
            
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡πÅ‡∏ú‡∏á_${new Date().toLocaleDateString('th-TH').replace(/\//g, '-')}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showMessage('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!', 'success');
        }

        function backupData() {
            if (rentals.length === 0) {
                showMessage('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏™‡∏≥‡∏£‡∏≠‡∏á', 'warning');
                return;
            }

            const backupData = {
                rentals: rentals,
                nextId: nextId,
                backupDate: new Date().toISOString(),
                version: '1.0'
            };

            const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡πÅ‡∏ú‡∏á_${new Date().toLocaleDateString('th-TH').replace(/\//g, '-')}.json`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showMessage('‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!', 'success');
        }

        function copyForGoogleSheets() {
            if (rentals.length === 0) {
                showMessage('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å', 'warning');
                return;
            }

            const headers = ['‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤', '‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£', '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÅ‡∏ú‡∏á', '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå', '‡∏Ñ‡πà‡∏≤‡∏•‡πá‡∏≠‡∏Ñ', '‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á', '‡∏£‡∏ß‡∏°', '‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏±‡∏ç‡∏ç‡∏≤', '‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤', '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞', '‡∏ú‡∏π‡πâ‡∏Ñ‡πâ‡∏≥‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô', '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ú‡∏π‡πâ‡∏Ñ‡πâ‡∏≥‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô', '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ú‡∏π‡πâ‡∏Ñ‡πâ‡∏≥‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô', '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏'];
            
            const data = rentals.map(rental => {
                const daysLeft = getDaysUntilExpiry(rental.contractEndDate);
                const daysLeftText = daysLeft !== null ? 
                    (daysLeft <= 0 ? '‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß' : `${daysLeft} ‡∏ß‡∏±‡∏ô`) : 
                    '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                
                return [
                    rental.tenantName || '',
                    rental.building || '',
                    rental.stallNumber || '',
                    rental.productType || '',
                    rental.phone || '',
                    rental.lockFee || 0,
                    rental.commonFee || 0,
                    (rental.lockFee || 0) + (rental.commonFee || 0),
                    formatDate(rental.contractStartDate),
                    formatDate(rental.contractEndDate),
                    daysLeftText,
                    rental.paymentStatus || '',
                    rental.paymentDate || '',
                    rental.guarantorName || '',
                    rental.guarantorPhone || '',
                    rental.guarantorRelation || '',
                    rental.guarantorAddress || '',
                    rental.notes || ''
                ];
            });

            const allData = [headers, ...data];
            const tsvContent = allData.map(row => row.join('\t')).join('\n');
            
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(tsvContent).then(() => {
                    showMessage(`‚úÖ ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${rentals.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! ‡πÑ‡∏õ‡∏ß‡∏≤‡∏á‡πÉ‡∏ô Google Sheets ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢`, 'success');
                }).catch(err => {
                    console.log('Clipboard API failed, trying fallback:', err);
                    copyToClipboardFallback(tsvContent);
                });
            } else {
                copyToClipboardFallback(tsvContent);
            }
        }

        function copyToClipboardFallback(text) {
            try {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'absolute';
                textArea.style.left = '-9999px';
                textArea.style.top = '0';
                textArea.style.opacity = '0';
                textArea.style.pointerEvents = 'none';
                textArea.setAttribute('readonly', '');
                textArea.setAttribute('tabindex', '-1');
                
                document.body.appendChild(textArea);
                
                textArea.select();
                textArea.setSelectionRange(0, textArea.value.length);
                
                let successful = false;
                try {
                    successful = document.execCommand('copy');
                } catch (err) {
                    console.error('execCommand failed:', err);
                }
                
                document.body.removeChild(textArea);
                
                if (successful) {
                    showMessage(`‚úÖ ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${rentals.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! ‡πÑ‡∏õ‡∏ß‡∏≤‡∏á‡πÉ‡∏ô Google Sheets ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢`, 'success');
                } else {
                    showCopyDataModal(text);
                }
            } catch (err) {
                console.error('Copy failed:', err);
                showCopyDataModal(text);
            }
        }

        function showCopyDataModal(data) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 mx-4 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="mb-4">
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">üìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Google Sheets</h3>
                        <p class="text-sm text-gray-600">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å (Ctrl+C ‡∏´‡∏£‡∏∑‡∏≠ Cmd+C)</p>
                    </div>
                    <textarea readonly class="w-full h-96 p-3 border border-gray-300 rounded-lg text-sm font-mono bg-gray-50 text-gray-900" onclick="this.select()">${data}</textarea>
                    <div class="mt-4 flex space-x-3">
                        <button onclick="this.parentElement.parentElement.parentElement.remove(); showMessage('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏õ‡∏ß‡∏≤‡∏á‡πÉ‡∏ô Google Sheets', 'success');" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg">
                            ‚úÖ ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß
                        </button>
                        <button onclick="this.parentElement.parentElement.parentElement.remove();" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-2 px-4 rounded-lg">
                            ‡∏õ‡∏¥‡∏î
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            const textarea = modal.querySelector('textarea');
            setTimeout(() => {
                textarea.focus();
                textarea.select();
            }, 100);
        }

        function showPasteFromSheetsModal() {
            const modal = document.getElementById('pasteFromSheetsModal');
            if (modal) {
                modal.classList.remove('hidden');
                const textarea = document.getElementById('sheetsDataInput');
                if (textarea) {
                    textarea.value = '';
                    setTimeout(() => {
                        textarea.focus();
                    }, 100);
                }
            } else {
                showMessage('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
            }
        }

        function closePasteFromSheetsModal() {
            const modal = document.getElementById('pasteFromSheetsModal');
            modal.classList.add('hidden');
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const fileExtension = file.name.split('.').pop().toLowerCase();
            
            if (!['json', 'csv'].includes(fileExtension)) {
                showMessage('‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÑ‡∏ü‡∏•‡πå .json ‡πÅ‡∏•‡∏∞ .csv ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô', 'error');
                event.target.value = '';
                return;
            }

            showMessage('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå...', 'warning');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;

                    if (fileExtension === 'json') {
                        importFromJSON(content);
                    } else if (fileExtension === 'csv') {
                        importFromCSV(content);
                    }
                } catch (error) {
                    console.error('File reading error:', error);
                    showMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå: ' + error.message, 'error');
                }
            };

            reader.onerror = function() {
                showMessage('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ', 'error');
            };

            reader.readAsText(file, 'UTF-8');
            
            event.target.value = '';
        }

        function importFromJSON(content) {
            try {
                const data = JSON.parse(content);
                let importedRentals = [];

                if (data.rentals && Array.isArray(data.rentals)) {
                    importedRentals = data.rentals;
                    if (data.nextId) {
                        nextId = Math.max(nextId, data.nextId);
                    }
                } else if (Array.isArray(data)) {
                    importedRentals = data;
                } else {
                    showMessage('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå JSON ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
                    return;
                }

                if (importedRentals.length === 0) {
                    showMessage('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå', 'warning');
                    return;
                }

                importedRentals.forEach(rental => {
                    if (!rental.id) {
                        rental.id = nextId++;
                    }
                });

                showConfirmModal(
                    `‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${importedRentals.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`,
                    () => {
                        rentals = importedRentals;
                        saveToStorage();
                        renderSpreadsheet();
                        updateDashboard();
                        showMessage(`‚úÖ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå JSON ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${importedRentals.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'success');
                    }
                );

            } catch (error) {
                console.error('JSON import error:', error);
                showMessage('‡πÑ‡∏ü‡∏•‡πå JSON ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: ' + error.message, 'error');
            }
        }

        function importFromCSV(content) {
            try {
                const lines = content.split('\n').filter(line => line.trim());
                
                if (lines.length < 2) {
                    showMessage('‡πÑ‡∏ü‡∏•‡πå CSV ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡πÅ‡∏ñ‡∏ß', 'error');
                    return;
                }

                const headerLine = lines[0];
                const expectedHeaders = ['‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤', '‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£', '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÅ‡∏ú‡∏á'];
                const hasValidHeaders = expectedHeaders.some(header => headerLine.includes(header));
                
                if (!hasValidHeaders) {
                    showMessage('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå CSV', 'error');
                    return;
                }

                const importedRentals = [];
                const dataLines = lines.slice(1);

                for (let i = 0; i < dataLines.length; i++) {
                    const line = dataLines[i].trim();
                    if (!line) continue;

                    const columns = parseCSVLine(line);
                    
                    if (columns.length >= 3 && columns[0].trim() && columns[2].trim()) {
                        const parseDate = (dateStr) => {
                            if (!dateStr) return '';
                            const cleanStr = dateStr.trim().replace(/"/g, '');
                            
                            const parts = cleanStr.split('/');
                            if (parts.length === 3) {
                                const day = parts[0].padStart(2, '0');
                                const month = parts[1].padStart(2, '0');
                                const year = parts[2];
                                return `${year}-${month}-${day}`;
                            }
                            
                            if (cleanStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
                                return cleanStr;
                            }
                            
                            return '';
                        };

                        const rental = {
                            id: nextId++,
                            tenantName: columns[0].replace(/"/g, '').trim(),
                            building: columns[1] ? columns[1].replace(/"/g, '').trim() : '',
                            stallNumber: columns[2].replace(/"/g, '').trim(),
                            productType: columns[3] ? columns[3].replace(/"/g, '').trim() : '',
                            phone: columns[4] ? columns[4].replace(/"/g, '').trim() : '',
                            lockFee: columns[5] ? parseFloat(columns[5].replace(/[^\d.-]/g, '')) || 0 : 0,
                            commonFee: columns[6] ? parseFloat(columns[6].replace(/[^\d.-]/g, '')) || 0 : 0,
                            contractStartDate: columns[8] ? parseDate(columns[8]) : '',
                            contractEndDate: columns[9] ? parseDate(columns[9]) : '',
                            paymentStatus: columns[11] ? columns[11].replace(/"/g, '').trim() : '',
                            paymentDate: columns[12] ? columns[12].replace(/"/g, '').trim() : '',
                            guarantorName: columns[13] ? columns[13].replace(/"/g, '').trim() : '',
                            guarantorPhone: columns[14] ? columns[14].replace(/"/g, '').trim() : '',
                            guarantorRelation: columns[15] ? columns[15].replace(/"/g, '').trim() : '',
                            guarantorAddress: columns[16] ? columns[16].replace(/"/g, '').trim() : '',
                            notes: columns[17] ? columns[17].replace(/"/g, '').trim() : '',
                            createdAt: new Date().toISOString()
                        };

                        importedRentals.push(rental);
                    }
                }

                if (importedRentals.length === 0) {
                    showMessage('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå CSV', 'error');
                    return;
                }

                showConfirmModal(
                    `‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${importedRentals.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`,
                    () => {
                        rentals = importedRentals;
                        saveToStorage();
                        renderSpreadsheet();
                        updateDashboard();
                        showMessage(`‚úÖ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå CSV ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${importedRentals.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'success');
                    }
                );

            } catch (error) {
                console.error('CSV import error:', error);
                showMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå CSV: ' + error.message, 'error');
            }
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result;
        }

        function importFromSheets() {
            const textarea = document.getElementById('sheetsDataInput');
            const importModeElement = document.querySelector('input[name="importMode"]:checked');
            
            if (!textarea) {
                showMessage('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                return;
            }
            
            if (!importModeElement) {
                showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤', 'warning');
                return;
            }
            
            const importMode = importModeElement.value;
            const data = textarea.value.trim();
            
            if (!data) {
                showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets', 'warning');
                return;
            }

            try {
                const lines = data.split('\n').filter(line => line.trim());
                
                if (lines.length < 2) {
                    showMessage('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡πÅ‡∏ñ‡∏ß', 'error');
                    return;
                }

                const headerLine = lines[0];
                
                const expectedHeaders = ['‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤', '‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£', '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÅ‡∏ú‡∏á', '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'];
                const hasValidHeaders = expectedHeaders.some(header => headerLine.includes(header));
                
                if (!hasValidHeaders) {
                    showMessage('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏°‡∏≤‡∏î‡πâ‡∏ß‡∏¢', 'error');
                    return;
                }

                const importedRentals = [];
                const dataLines = lines.slice(1);

                for (let i = 0; i < dataLines.length; i++) {
                    const line = dataLines[i].trim();
                    if (!line) continue;

                    let columns = line.split('\t');
                    if (columns.length === 1) {
                        columns = line.split(',');
                    }

                    if (columns.length >= 3 && columns[0].trim() && columns[2].trim()) {
                        const parseThaiDate = (dateStr) => {
                            if (!dateStr) return '';
                            const cleanStr = dateStr.trim();
                            
                            const parts = cleanStr.split('/');
                            if (parts.length === 3) {
                                const day = parts[0].padStart(2, '0');
                                const month = parts[1].padStart(2, '0');
                                const year = parts[2];
                                return `${year}-${month}-${day}`;
                            }
                            
                            if (cleanStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
                                return cleanStr;
                            }
                            
                            return '';
                        };

                        const rental = {
                            id: nextId++,
                            tenantName: columns[0].trim(),
                            building: columns[1] ? columns[1].trim() : '',
                            stallNumber: columns[2].trim(),
                            productType: columns[3] ? columns[3].trim() : '',
                            phone: columns[4] ? columns[4].trim() : '',
                            lockFee: columns[5] ? parseFloat(columns[5].replace(/[^\d.-]/g, '')) || 0 : 0,
                            commonFee: columns[6] ? parseFloat(columns[6].replace(/[^\d.-]/g, '')) || 0 : 0,
                            contractStartDate: columns[8] ? parseThaiDate(columns[8]) : '',
                            contractEndDate: columns[9] ? parseThaiDate(columns[9]) : '',
                            paymentStatus: columns[11] ? columns[11].trim() : '',
                            paymentDate: columns[12] ? columns[12].trim() : '',
                            guarantorName: columns[13] ? columns[13].trim() : '',
                            guarantorPhone: columns[14] ? columns[14].trim() : '',
                            guarantorRelation: columns[15] ? columns[15].trim() : '',
                            guarantorAddress: columns[16] ? columns[16].trim() : '',
                            notes: columns[17] ? columns[17].trim() : '',
                            createdAt: new Date().toISOString()
                        };

                        importedRentals.push(rental);
                    }
                }

                if (importedRentals.length === 0) {
                    showMessage('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ß‡∏≤‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                    return;
                }

                if (importMode === 'replace') {
                    rentals = importedRentals;
                } else {
                    rentals = [...importedRentals, ...rentals];
                }

                saveToStorage();
                renderSpreadsheet();
                updateDashboard();
                closePasteFromSheetsModal();
                
                const modeText = importMode === 'replace' ? '‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°';
                showMessage(`‚úÖ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${importedRentals.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ (${modeText})`, 'success');

            } catch (error) {
                console.error('Import error:', error);
                showMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message, 'error');
            }
        }

        function printReport() {
            if (rentals.length === 0) {
                showMessage('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå', 'warning');
                return;
            }

            const stats = calculateStatistics();
            const now = new Date();
            const printWindow = window.open('', '_blank');
            
            const printContent = `
                <!DOCTYPE html>
                <html lang="th">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡πÅ‡∏ú‡∏á‡πÉ‡∏ô‡∏ï‡∏•‡∏≤‡∏î</title>
                    <style>
                        body { font-family: 'Sarabun', Arial, sans-serif; margin: 20px; color: #333; }
                        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 15px; }
                        .header h1 { margin: 0; font-size: 24px; }
                        .header p { margin: 5px 0; color: #666; }
                        .summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px; }
                        .summary-card { border: 1px solid #ddd; padding: 15px; border-radius: 8px; background: #f9f9f9; }
                        .summary-card h3 { margin: 0 0 10px 0; font-size: 14px; color: #666; }
                        .summary-card .value { font-size: 20px; font-weight: bold; color: #333; }
                        table { width: 100%; border-collapse: collapse; margin-bottom<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98e55bdb9375fd2a',t:'MTc2MDQyNjg5NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
