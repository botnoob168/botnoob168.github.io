<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏•‡∏≤‡∏î</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .table-container {
            overflow-x: auto;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }
        .spreadsheet-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            font-size: 14px;
        }
        .spreadsheet-table th {
            background: #f8f9fa;
            border: 1px solid #e5e7eb;
            padding: 8px 12px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .spreadsheet-table td {
            border: 1px solid #e5e7eb;
            padding: 8px 12px;
            vertical-align: top;
        }
        .spreadsheet-table tr:hover {
            background: #f9fafb;
        }
        .row-number {
            background: #f8f9fa;
            color: #6b7280;
            font-weight: 500;
            text-align: center;
            width: 50px;
            min-width: 50px;
        }
        .editable-cell {
            cursor: pointer;
            min-height: 20px;
        }
        .editable-cell:hover {
            background: #f3f4f6;
        }
        .cell-input {
            border: 2px solid #3b82f6;
            outline: none;
            background: white;
            width: 100%;
            padding: 4px;
            font-size: 14px;
        }
        .status-paid { background: #dcfce7; color: #166534; }
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-overdue { background: #fee2e2; color: #dc2626; }
        
        /* Stall styles */
        .stall {
            width: 60px;
            height: 60px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 12px;
            font-weight: 600;
        }
        .stall:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .stall-available {
            background: #dcfce7;
            border-color: #16a34a;
            color: #166534;
        }
        .stall-occupied {
            background: #dbeafe;
            border-color: #2563eb;
            color: #1e40af;
        }
        .stall-booked {
            background: #fef3c7;
            border-color: #d97706;
            color: #92400e;
        }
        .stall-expired {
            background: #fee2e2;
            border-color: #dc2626;
            color: #dc2626;
        }
        .stall-expiring {
            background: #fef3c7;
            border-color: #f59e0b;
            color: #92400e;
            animation: pulse 2s infinite;
        }
        
        /* Notification styles */
        .notification-item {
            border-left: 4px solid #e5e7eb;
            transition: all 0.2s;
        }
        .notification-critical {
            border-left-color: #dc2626;
            background: #fef2f2;
        }
        .notification-warning {
            border-left-color: #f59e0b;
            background: #fffbeb;
        }
        .notification-info {
            border-left-color: #3b82f6;
            background: #eff6ff;
        }
        .notification-filter.active {
            background: #3b82f6 !important;
            color: white !important;
        }
        
        /* Expiring row highlight */
        .row-expiring-critical {
            background: #fef2f2 !important;
        }
        .row-expiring-warning {
            background: #fffbeb !important;
        }
        .row-expiring-info {
            background: #eff6ff !important;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .notification-badge {
            animation: bounce 1s infinite;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-full">
    <div class="container mx-auto px-4 py-6">
        <!-- Header -->
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center">
                <div class="bg-green-600 rounded-lg w-10 h-10 mr-3 flex items-center justify-center">
                    <span class="text-white text-xl">üìä</span>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡πÅ‡∏ú‡∏á‡πÉ‡∏ô‡∏ï‡∏•‡∏≤‡∏î</h1>
                    <p class="text-gray-600 text-sm">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡πÅ‡∏ú‡∏á</p>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <button id="notificationToggle" onclick="toggleNotifications()" 
                        class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm flex items-center relative">
                    <span class="mr-2">üîî</span>‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
                    <span id="notificationBadge" class="absolute -top-2 -right-2 bg-yellow-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden notification-badge">0</span>
                </button>
                <button id="mapViewToggle" onclick="toggleMapView()" 
                        class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm flex items-center">
                    <span class="mr-2">üó∫Ô∏è</span>‡πÅ‡∏ú‡∏ô‡∏ú‡∏±‡∏á‡∏ï‡∏•‡∏≤‡∏î
                </button>
                <button id="viewToggle" onclick="toggleView()" 
                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm flex items-center">
                    <span class="mr-2">üìã</span>‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°
                </button>
            </div>
        </div>

        <!-- Notifications Panel -->
        <div id="notificationsPanel" class="bg-white rounded-xl shadow-lg p-6 mb-6 hidden">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                    <span class="mr-2">üîî</span>‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏
                </h3>
                <button onclick="markAllAsRead()" class="text-sm text-blue-600 hover:text-blue-800">
                    ‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏≠‡πà‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </button>
            </div>
            
            <!-- Notification Filters -->
            <div class="flex flex-wrap gap-2 mb-4">
                <button onclick="filterNotifications('all')" 
                        class="notification-filter active px-3 py-1 rounded-full text-sm bg-blue-100 text-blue-800">
                    ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (<span id="countAll">0</span>)
                </button>
                <button onclick="filterNotifications('critical')" 
                        class="notification-filter px-3 py-1 rounded-full text-sm bg-gray-100 text-gray-600 hover:bg-red-100 hover:text-red-800">
                    ‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô ‚â§7 ‡∏ß‡∏±‡∏ô (<span id="countCritical">0</span>)
                </button>
                <button onclick="filterNotifications('warning')" 
                        class="notification-filter px-3 py-1 rounded-full text-sm bg-gray-100 text-gray-600 hover:bg-yellow-100 hover:text-yellow-800">
                    ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô ‚â§15 ‡∏ß‡∏±‡∏ô (<span id="countWarning">0</span>)
                </button>
                <button onclick="filterNotifications('info')" 
                        class="notification-filter px-3 py-1 rounded-full text-sm bg-gray-100 text-gray-600 hover:bg-blue-100 hover:text-blue-800">
                    ‡πÅ‡∏à‡πâ‡∏á‡πÉ‡∏´‡πâ‡∏ó‡∏£‡∏≤‡∏ö ‚â§30 ‡∏ß‡∏±‡∏ô (<span id="countInfo">0</span>)
                </button>
            </div>
            
            <!-- Notifications List -->
            <div id="notificationsList" class="space-y-3 max-h-96 overflow-y-auto">
                <!-- Notifications will be rendered here -->
            </div>
        </div>

        <!-- Add Rental Form -->
        <div id="formView" class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                <span class="mr-2">‚ûï</span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡πÅ‡∏ú‡∏á
            </h2>
            <form id="rentalForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤</label>
                    <input type="text" id="tenantName" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£</label>
                    <select id="building" required 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£</option>
                        <option value="‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ A">‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ A</option>
                        <option value="‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ B">‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ B</option>
                        <option value="‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ C">‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ C</option>
                        <option value="‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ D">‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ D</option>
                        <option value="‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ E">‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ E</option>
                        <option value="‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ F">‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ F</option>
                        <option value="‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ G">‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ G</option>
                        <option value="‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ H">‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ H</option>
                        <option value="‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ I">‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ I</option>
                        <option value="‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ J">‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ J</option>
                        <option value="‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ K">‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ K</option>
                        <option value="‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ L">‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ L</option>
                        <option value="‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ M">‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ M</option>
                        <option value="‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ N">‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ N</option>
                        <option value="‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ O">‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ O</option>
                        <option value="‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ P">‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ P</option>
                        <option value="‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ Q">‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ Q</option>
                        <option value="‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ R">‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ R</option>
                        <option value="‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ S">‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ S</option>
                        <option value="‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ T">‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ T</option>
                        <option value="‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ U">‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ U</option>
                        <option value="‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ V">‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ V</option>
                        <option value="‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ W">‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ W</option>
                        <option value="‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ X">‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ X</option>
                        <option value="‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ Y">‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ Y</option>
                        <option value="‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ Z">‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ Z</option>
                        <option value="‡πÇ‡∏ã‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á">‡πÇ‡∏ã‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÅ‡∏ú‡∏á</label>
                    <input type="text" id="stallNumber" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="‡πÄ‡∏ä‡πà‡∏ô 01, 02, 03">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                    <select id="productType" required onchange="toggleCustomProductType()"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</option>
                        <option value="‡∏ú‡∏±‡∏Å-‡∏ú‡∏•‡πÑ‡∏°‡πâ">‡∏ú‡∏±‡∏Å-‡∏ú‡∏•‡πÑ‡∏°‡πâ</option>
                        <option value="‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå">‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå</option>
                        <option value="‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏´‡πâ‡∏á">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏´‡πâ‡∏á</option>
                        <option value="‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∏‡∏á">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∏‡∏á</option>
                        <option value="‡∏Ç‡∏ô‡∏°-‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°">‡∏Ç‡∏ô‡∏°-‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</option>
                        <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                        <option value="custom">‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏£‡∏∞‡∏ö‡∏∏)</option>
                    </select>
                    <input type="text" id="customProductType" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent mt-2 hidden"
                           placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡πÄ‡∏ä‡πà‡∏ô ‡∏°‡∏∞‡∏°‡πà‡∏ß‡∏á, ‡∏õ‡∏•‡∏≤‡∏ó‡∏π, ‡∏Ç‡∏ô‡∏°‡∏Ñ‡∏£‡∏Å">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                    <input type="tel" id="phoneNumber" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="08X-XXX-XXXX">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">‡∏Ñ‡πà‡∏≤‡∏•‡πá‡∏≠‡∏Ñ/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
                    <input type="number" id="lockFee" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="0">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
                    <input type="number" id="commonFee" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="0">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏±‡∏ç‡∏ç‡∏≤</label>
                    <input type="date" id="contractStartDate" required onchange="calculateEndDate()"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤</label>
                    <select id="rentMonth" required onchange="calculateEndDate()"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</option>
                        <option value="1">1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                        <option value="3">3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                        <option value="6">6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                        <option value="12">1 ‡∏õ‡∏µ</option>
                        <option value="24">2 ‡∏õ‡∏µ</option>
                        <option value="36">3 ‡∏õ‡∏µ</option>
                        <option value="60">5 ‡∏õ‡∏µ</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤</label>
                    <input type="date" id="contractEndDate" readonly 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-600">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤</label>
                    <select id="paymentStatus" required 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
                        <option value="‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÅ‡∏•‡πâ‡∏ß">‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÅ‡∏•‡πâ‡∏ß</option>
                        <option value="‡∏£‡∏≠‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤">‡∏£‡∏≠‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤</option>
                        <option value="‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏">‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏≥‡∏£‡∏∞‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≤‡∏¢10‡∏ß‡∏±‡∏ô</label>
                    <select id="paymentDate" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞</option>
                        <option value="‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                        <option value="‡∏£‡∏≤‡∏¢10‡∏ß‡∏±‡∏ô">‡∏£‡∏≤‡∏¢10‡∏ß‡∏±‡∏ô</option>
                    </select>
                </div>

                <div class="md:col-span-2 lg:col-span-3">
                    <label class="block text-sm font-medium text-gray-700 mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                    <textarea id="notes" rows="2" 
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                              placeholder="‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."></textarea>
                </div>

                <div class="md:col-span-2 lg:col-span-3">
                    <button type="submit" 
                            class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-4 rounded-lg transition duration-200 flex items-center justify-center">
                        <span class="mr-2">üíæ</span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </button>
                </div>
            </form>
        </div>

        <!-- Market Map View -->
        <div id="mapView" class="bg-white rounded-xl shadow-lg p-6 mb-6 hidden">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                    <span class="mr-2">üó∫Ô∏è</span>‡πÅ‡∏ú‡∏ô‡∏ú‡∏±‡∏á‡∏ï‡∏•‡∏≤‡∏î
                </h3>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2 text-sm">
                        <div class="w-4 h-4 bg-green-500 rounded"></div>
                        <span>‡∏ß‡πà‡∏≤‡∏á</span>
                        <div class="w-4 h-4 bg-blue-500 rounded ml-4"></div>
                        <span>‡πÄ‡∏ä‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß</span>
                        <div class="w-4 h-4 bg-yellow-500 rounded ml-4"></div>
                        <span>‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß</span>
                        <div class="w-4 h-4 bg-red-500 rounded ml-4"></div>
                        <span>‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</span>
                        <div class="w-4 h-4 bg-orange-500 rounded ml-4 animate-pulse"></div>
                        <span>‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</span>
                    </div>
                </div>
            </div>
            
            <!-- Building Selection -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£</label>
                <select id="buildingSelect" onchange="renderBuildingMap()" 
                        class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ A">‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ A</option>
                    <option value="‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ B">‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ B</option>
                    <option value="‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ C">‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ C</option>
                    <option value="‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ D">‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ D</option>
                    <option value="‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ E">‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ E</option>
                    <option value="‡πÇ‡∏ã‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á">‡πÇ‡∏ã‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á</option>
                </select>
            </div>
            
            <!-- Building Map Grid -->
            <div id="buildingMap" class="grid grid-cols-10 gap-2 max-w-4xl mx-auto">
                <!-- Stalls will be rendered here -->
            </div>
        </div>

        <!-- Search Bar & Data Management -->
        <div class="bg-white rounded-xl shadow-lg p-4 mb-6">
            <div class="flex flex-col md:flex-row gap-4 mb-4">
                <div class="relative flex-1">
                    <input type="text" id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•..." 
                           class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <span class="absolute left-3 top-2.5 text-gray-400">üîç</span>
                </div>
                <button onclick="addNewRow()" 
                        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center justify-center">
                    <span class="mr-2">‚ûï</span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß‡πÉ‡∏´‡∏°‡πà
                </button>
            </div>
            
            <!-- Data Management Buttons -->
            <div class="grid grid-cols-2 md:grid-cols-6 gap-2">
                <button onclick="exportData()" 
                        class="bg-green-500 hover:bg-green-600 text-white text-sm py-2 px-3 rounded-lg flex items-center justify-center transition duration-200">
                    <span class="mr-1">üì§</span>‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV
                </button>
                <button onclick="document.getElementById('importFile').click()" 
                        class="bg-blue-500 hover:bg-blue-600 text-white text-sm py-2 px-3 rounded-lg flex items-center justify-center transition duration-200">
                    <span class="mr-1">üì•</span>‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå
                </button>
                <button onclick="showGoogleSheetsModal()" 
                        class="bg-indigo-500 hover:bg-indigo-600 text-white text-sm py-2 px-3 rounded-lg flex items-center justify-center transition duration-200">
                    <span class="mr-1">üìä</span>‡∏à‡∏≤‡∏Å Sheets
                </button>
                <button onclick="backupData()" 
                        class="bg-purple-500 hover:bg-purple-600 text-white text-sm py-2 px-3 rounded-lg flex items-center justify-center transition duration-200">
                    <span class="mr-1">üíæ</span>‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                </button>
                <button onclick="document.getElementById('restoreFile').click()" 
                        class="bg-orange-500 hover:bg-orange-600 text-white text-sm py-2 px-3 rounded-lg flex items-center justify-center transition duration-200">
                    <span class="mr-1">üîÑ</span>‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                </button>
                <button onclick="clearAllData()" 
                        class="bg-red-500 hover:bg-red-600 text-white text-sm py-2 px-3 rounded-lg flex items-center justify-center transition duration-200">
                    <span class="mr-1">üóëÔ∏è</span>‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                </button>
            </div>
            
            <!-- Hidden file inputs -->
            <input type="file" id="importFile" accept=".csv,.json" style="display: none;" onchange="importData(event)">
            <input type="file" id="restoreFile" accept=".json" style="display: none;" onchange="restoreData(event)">
        </div>

        <!-- Spreadsheet View -->
        <div id="spreadsheetView" class="bg-white rounded-xl shadow-lg p-4">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                    <span class="mr-2">üìä</span>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡πÅ‡∏ú‡∏á
                </h3>
                <div class="flex items-center space-x-4">
                    <span id="recordCount" class="text-sm bg-green-100 text-green-800 px-3 py-1 rounded-full">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                    <div class="text-sm text-gray-600">
                        ‡∏£‡∏ß‡∏°: <span id="totalAmount" class="font-semibold text-green-600">0</span> ‡∏ö‡∏≤‡∏ó
                    </div>
                </div>
            </div>
            
            <div class="table-container">
                <table class="spreadsheet-table">
                    <thead>
                        <tr>
                            <th class="row-number">#</th>
                            <th style="min-width: 120px;">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤</th>
                            <th style="min-width: 80px;">‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£</th>
                            <th style="min-width: 80px;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÅ‡∏ú‡∏á</th>
                            <th style="min-width: 100px;">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                            <th style="min-width: 120px;">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</th>
                            <th style="min-width: 80px;">‡∏Ñ‡πà‡∏≤‡∏•‡πá‡∏≠‡∏Ñ</th>
                            <th style="min-width: 80px;">‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á</th>
                            <th style="min-width: 80px;">‡∏£‡∏ß‡∏°</th>
                            <th style="min-width: 100px;">‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏±‡∏ç‡∏ç‡∏≤</th>
                            <th style="min-width: 100px;">‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤</th>
                            <th style="min-width: 80px;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                            <th style="min-width: 120px;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤</th>
                            <th style="min-width: 120px;">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞</th>
                            <th style="min-width: 150px;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                            <th style="min-width: 80px;">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody id="spreadsheetBody">
                        <tr>
                            <td colspan="16" class="text-center text-gray-500 py-8">
                                <div>
                                    <span class="text-4xl mb-2 block">üìä</span>
                                    <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡πÅ‡∏ú‡∏á</p>
                                    <p class="text-sm">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÇ‡∏î‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏Å</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Success/Error Message -->
        <div id="successMessage" class="fixed top-4 left-4 right-4 bg-green-500 text-white p-4 rounded-lg shadow-lg transform -translate-y-full opacity-0 transition-all duration-300 z-50">
            <div class="flex items-center">
                <span class="mr-2">‚úÖ</span>
                <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!</span>
            </div>
        </div>

        <!-- Stall Booking Modal -->
        <div id="stallBookingModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-xl p-6 mx-4 max-w-md w-full">
                <div class="text-center mb-4">
                    <span class="text-4xl mb-2 block">üè™</span>
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">‡∏à‡∏≠‡∏á‡πÅ‡∏ú‡∏á</h3>
                    <p id="stallInfo" class="text-gray-600 text-sm mb-4"></p>
                </div>
                
                <form id="bookingForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á</label>
                        <input type="text" id="bookingName" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                        <input type="tel" id="bookingPhone" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                        <select id="bookingProductType" required 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</option>
                            <option value="‡∏ú‡∏±‡∏Å-‡∏ú‡∏•‡πÑ‡∏°‡πâ">‡∏ú‡∏±‡∏Å-‡∏ú‡∏•‡πÑ‡∏°‡πâ</option>
                            <option value="‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå">‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå</option>
                            <option value="‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏´‡πâ‡∏á">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏´‡πâ‡∏á</option>
                            <option value="‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∏‡∏á">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∏‡∏á</option>
                            <option value="‡∏Ç‡∏ô‡∏°-‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°">‡∏Ç‡∏ô‡∏°-‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</option>
                            <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏á</label>
                        <input type="date" id="bookingDate" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                        <textarea id="bookingNotes" rows="2" 
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                  placeholder="‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."></textarea>
                    </div>
                </form>
                
                <div class="flex space-x-3 mt-6">
                    <button onclick="confirmBooking()" 
                            class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white py-2 px-4 rounded-lg">
                        ‡∏à‡∏≠‡∏á‡πÅ‡∏ú‡∏á
                    </button>
                    <button onclick="closeBookingModal()" 
                            class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-2 px-4 rounded-lg">
                        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                </div>
            </div>
        </div>

        <!-- Google Sheets Import Modal -->
        <div id="googleSheetsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-xl p-6 mx-4 max-w-md w-full">
                <div class="text-center mb-4">
                    <span class="text-4xl mb-2 block">üìä</span>
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏≤‡∏Å Google Sheets</h3>
                    <p class="text-gray-600 text-sm mb-4">‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå Google Sheets ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏•‡∏¥‡∏á‡∏Å‡πå Google Sheets</label>
                    <input type="url" id="googleSheetsUrl" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="https://docs.google.com/spreadsheets/d/...">
                </div>
                
                <div class="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <p class="text-sm text-yellow-800">
                        <strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> Google Sheets ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏î‡∏π‡πÑ‡∏î‡πâ (Public) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ
                    </p>
                </div>
                
                <div class="flex space-x-3">
                    <button onclick="importFromGoogleSheets()" 
                            class="flex-1 bg-indigo-500 hover:bg-indigo-600 text-white py-2 px-4 rounded-lg">
                        ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </button>
                    <button onclick="closeGoogleSheetsModal()" 
                            class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-2 px-4 rounded-lg">
                        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                </div>
            </div>
        </div>

        <!-- Confirmation Modal -->
        <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-xl p-6 mx-4 max-w-sm w-full">
                <div class="text-center mb-4">
                    <span class="text-4xl mb-2 block">‚ö†Ô∏è</span>
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
                    <p id="confirmText" class="text-gray-600 text-sm"></p>
                </div>
                <div class="flex space-x-3">
                    <button id="confirmYes" class="flex-1 bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-lg">
                        ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
                    </button>
                    <button id="confirmNo" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-2 px-4 rounded-lg">
                        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let rentals = JSON.parse(localStorage.getItem('marketRentals')) || [];
        let bookings = JSON.parse(localStorage.getItem('marketBookings')) || [];
        let nextId = parseInt(localStorage.getItem('nextRentalId')) || 1;
        let nextBookingId = parseInt(localStorage.getItem('nextBookingId')) || 1;
        let currentView = 'spreadsheet'; // 'form' or 'spreadsheet'
        let currentSelectedStall = null;
        let notifications = [];
        let currentNotificationFilter = 'all';

        function saveToStorage() {
            localStorage.setItem('marketRentals', JSON.stringify(rentals));
            localStorage.setItem('marketBookings', JSON.stringify(bookings));
            localStorage.setItem('nextRentalId', nextId.toString());
            localStorage.setItem('nextBookingId', nextBookingId.toString());
        }

        function calculateEndDate() {
            const startDate = document.getElementById('contractStartDate').value;
            const duration = document.getElementById('rentMonth').value;
            
            if (startDate && duration) {
                const start = new Date(startDate);
                const end = new Date(start);
                end.setMonth(end.getMonth() + parseInt(duration));
                
                document.getElementById('contractEndDate').value = end.toISOString().split('T')[0];
            }
        }

        function getDaysUntilExpiry(endDate) {
            if (!endDate) return null;
            const today = new Date();
            const expiry = new Date(endDate);
            const diffTime = expiry - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }

        function getExpiryStatus(daysLeft) {
            if (daysLeft === null) return null;
            if (daysLeft <= 0) return 'expired';
            if (daysLeft <= 7) return 'critical';
            if (daysLeft <= 15) return 'warning';
            if (daysLeft <= 30) return 'info';
            return 'normal';
        }

        function generateNotifications() {
            notifications = [];
            const today = new Date();
            
            rentals.forEach(rental => {
                if (!rental.contractEndDate || rental.paymentStatus === '‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏') return;
                
                const daysLeft = getDaysUntilExpiry(rental.contractEndDate);
                const status = getExpiryStatus(daysLeft);
                
                if (status === 'critical' || status === 'warning' || status === 'info') {
                    let priority = status;
                    let message = '';
                    let icon = '';
                    
                    if (status === 'critical') {
                        message = `‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÉ‡∏ô ${daysLeft} ‡∏ß‡∏±‡∏ô - ‡∏ï‡πâ‡∏≠‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡πà‡∏ß‡∏ô!`;
                        icon = 'üö®';
                    } else if (status === 'warning') {
                        message = `‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÉ‡∏ô ${daysLeft} ‡∏ß‡∏±‡∏ô - ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏±‡∏ç‡∏ç‡∏≤`;
                        icon = '‚ö†Ô∏è';
                    } else if (status === 'info') {
                        message = `‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÉ‡∏ô ${daysLeft} ‡∏ß‡∏±‡∏ô - ‡πÅ‡∏à‡πâ‡∏á‡πÉ‡∏´‡πâ‡∏ó‡∏£‡∏≤‡∏ö‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤`;
                        icon = '‚ÑπÔ∏è';
                    }
                    
                    notifications.push({
                        id: `${rental.id}_${status}`,
                        rentalId: rental.id,
                        type: status,
                        priority: priority,
                        title: `${rental.tenantName} - ${rental.building} ‡πÅ‡∏ú‡∏á ${rental.stallNumber}`,
                        message: message,
                        icon: icon,
                        daysLeft: daysLeft,
                        endDate: rental.contractEndDate,
                        phone: rental.phone,
                        createdAt: today.toISOString(),
                        read: false
                    });
                }
            });
            
            // Sort by priority and days left
            notifications.sort((a, b) => {
                const priorityOrder = { critical: 0, warning: 1, info: 2 };
                if (priorityOrder[a.priority] !== priorityOrder[b.priority]) {
                    return priorityOrder[a.priority] - priorityOrder[b.priority];
                }
                return a.daysLeft - b.daysLeft;
            });
        }

        function updateNotificationBadge() {
            const badge = document.getElementById('notificationBadge');
            const unreadCount = notifications.filter(n => !n.read).length;
            
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        function renderNotifications() {
            const notificationsList = document.getElementById('notificationsList');
            
            let filteredNotifications = notifications;
            if (currentNotificationFilter !== 'all') {
                filteredNotifications = notifications.filter(n => n.type === currentNotificationFilter);
            }
            
            // Update counts
            document.getElementById('countAll').textContent = notifications.length;
            document.getElementById('countCritical').textContent = notifications.filter(n => n.type === 'critical').length;
            document.getElementById('countWarning').textContent = notifications.filter(n => n.type === 'warning').length;
            document.getElementById('countInfo').textContent = notifications.filter(n => n.type === 'info').length;
            
            if (filteredNotifications.length === 0) {
                notificationsList.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <span class="text-4xl block mb-2">üéâ</span>
                        <p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</p>
                        <p class="text-sm">‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</p>
                    </div>
                `;
                return;
            }
            
            notificationsList.innerHTML = filteredNotifications.map(notification => `
                <div class="notification-item notification-${notification.type} p-4 rounded-lg ${notification.read ? 'opacity-75' : ''}">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center mb-2">
                                <span class="text-lg mr-2">${notification.icon}</span>
                                <h4 class="font-semibold text-gray-800">${notification.title}</h4>
                                ${notification.daysLeft <= 7 ? '<span class="ml-2 px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full">‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô</span>' : ''}
                            </div>
                            <p class="text-sm text-gray-600 mb-2">${notification.message}</p>
                            <div class="flex items-center text-xs text-gray-500 space-x-4">
                                <span>üìÖ ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏: ${new Date(notification.endDate).toLocaleDateString('th-TH')}</span>
                                ${notification.phone ? `<span>üìû ${notification.phone}</span>` : ''}
                            </div>
                        </div>
                        <div class="flex flex-col space-y-1 ml-4">
                            <button onclick="markAsRead('${notification.id}')" 
                                    class="text-xs px-2 py-1 bg-blue-100 text-blue-800 rounded hover:bg-blue-200">
                                ${notification.read ? '‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß' : '‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢'}
                            </button>
                            <button onclick="goToRental(${notification.rentalId})" 
                                    class="text-xs px-2 py-1 bg-green-100 text-green-800 rounded hover:bg-green-200">
                                ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function toggleNotifications() {
            const panel = document.getElementById('notificationsPanel');
            const toggle = document.getElementById('notificationToggle');
            
            if (panel.classList.contains('hidden')) {
                generateNotifications();
                renderNotifications();
                updateNotificationBadge();
                panel.classList.remove('hidden');
                toggle.innerHTML = '<span class="mr-2">üîî</span>‡∏ã‡πà‡∏≠‡∏ô‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô';
            } else {
                panel.classList.add('hidden');
                toggle.innerHTML = '<span class="mr-2">üîî</span>‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô';
            }
        }

        function filterNotifications(type) {
            currentNotificationFilter = type;
            
            // Update active filter button
            document.querySelectorAll('.notification-filter').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            renderNotifications();
        }

        function markAsRead(notificationId) {
            const notification = notifications.find(n => n.id === notificationId);
            if (notification) {
                notification.read = true;
                renderNotifications();
                updateNotificationBadge();
            }
        }

        function markAllAsRead() {
            notifications.forEach(n => n.read = true);
            renderNotifications();
            updateNotificationBadge();
            showMessage('‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏≠‡πà‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß!', 'success');
        }

        function goToRental(rentalId) {
            // Close notifications panel
            document.getElementById('notificationsPanel').classList.add('hidden');
            document.getElementById('notificationToggle').innerHTML = '<span class="mr-2">üîî</span>‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô';
            
            // Highlight the rental row
            const rental = rentals.find(r => r.id === rentalId);
            if (rental) {
                // Search for the rental to filter the table
                document.getElementById('searchInput').value = rental.tenantName;
                document.getElementById('searchInput').dispatchEvent(new Event('input'));
                
                // Scroll to spreadsheet
                document.getElementById('spreadsheetView').scrollIntoView({ behavior: 'smooth' });
                
                showMessage(`‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${rental.tenantName} - ${rental.building} ‡πÅ‡∏ú‡∏á ${rental.stallNumber}`, 'info');
            }
        }

        function toggleCustomProductType() {
            const productType = document.getElementById('productType');
            const customProductType = document.getElementById('customProductType');
            
            if (productType.value === 'custom') {
                customProductType.classList.remove('hidden');
                customProductType.required = true;
                customProductType.focus();
            } else {
                customProductType.classList.add('hidden');
                customProductType.required = false;
                customProductType.value = '';
            }
        }

        function toggleView() {
            const formView = document.getElementById('formView');
            const viewToggle = document.getElementById('viewToggle');
            
            if (currentView === 'spreadsheet') {
                currentView = 'form';
                formView.style.display = 'block';
                viewToggle.innerHTML = '<span class="mr-2">üìä</span>‡∏ï‡∏≤‡∏£‡∏≤‡∏á';
            } else {
                currentView = 'spreadsheet';
                formView.style.display = 'none';
                viewToggle.innerHTML = '<span class="mr-2">üìã</span>‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°';
            }
        }

        function toggleMapView() {
            const mapView = document.getElementById('mapView');
            const mapViewToggle = document.getElementById('mapViewToggle');
            
            if (mapView.classList.contains('hidden')) {
                mapView.classList.remove('hidden');
                mapViewToggle.innerHTML = '<span class="mr-2">üìä</span>‡∏ï‡∏≤‡∏£‡∏≤‡∏á';
                renderBuildingMap();
            } else {
                mapView.classList.add('hidden');
                mapViewToggle.innerHTML = '<span class="mr-2">üó∫Ô∏è</span>‡πÅ‡∏ú‡∏ô‡∏ú‡∏±‡∏á‡∏ï‡∏•‡∏≤‡∏î';
            }
        }

        function getStallStatus(building, stallNumber) {
            // Check if stall is rented
            const rental = rentals.find(r => r.building === building && r.stallNumber === stallNumber);
            if (rental) {
                if (rental.paymentStatus === '‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏') return 'expired';
                
                // Check if contract is expiring soon
                const daysLeft = getDaysUntilExpiry(rental.contractEndDate);
                const expiryStatus = getExpiryStatus(daysLeft);
                if (expiryStatus === 'critical' || expiryStatus === 'warning') {
                    return 'expiring';
                }
                
                return 'occupied';
            }
            
            // Check if stall is booked
            const booking = bookings.find(b => b.building === building && b.stallNumber === stallNumber);
            if (booking) return 'booked';
            
            return 'available';
        }

        function renderBuildingMap() {
            const selectedBuilding = document.getElementById('buildingSelect').value;
            const buildingMap = document.getElementById('buildingMap');
            
            // Generate 50 stalls (5 rows x 10 columns) for each building
            let stallsHtml = '';
            for (let i = 1; i <= 50; i++) {
                const stallNumber = i.toString().padStart(2, '0');
                const status = getStallStatus(selectedBuilding, stallNumber);
                const rental = rentals.find(r => r.building === selectedBuilding && r.stallNumber === stallNumber);
                const booking = bookings.find(b => b.building === selectedBuilding && b.stallNumber === stallNumber);
                
                let statusClass = 'stall-available';
                let statusText = '‡∏ß‡πà‡∏≤‡∏á';
                let ownerInfo = '';
                
                if (status === 'occupied') {
                    statusClass = 'stall-occupied';
                    statusText = '‡πÄ‡∏ä‡πà‡∏≤';
                    ownerInfo = rental ? rental.tenantName : '';
                } else if (status === 'booked') {
                    statusClass = 'stall-booked';
                    statusText = '‡∏à‡∏≠‡∏á';
                    ownerInfo = booking ? booking.name : '';
                } else if (status === 'expired') {
                    statusClass = 'stall-expired';
                    statusText = '‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏';
                    ownerInfo = rental ? rental.tenantName : '';
                } else if (status === 'expiring') {
                    statusClass = 'stall-expiring';
                    statusText = '‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏';
                    ownerInfo = rental ? rental.tenantName : '';
                }
                
                stallsHtml += `
                    <div class="stall ${statusClass}" 
                         onclick="handleStallClick('${selectedBuilding}', '${stallNumber}', '${status}')"
                         title="${selectedBuilding} ‡πÅ‡∏ú‡∏á ${stallNumber} - ${statusText}${ownerInfo ? ' (' + ownerInfo + ')' : ''}">
                        <div class="text-xs">${stallNumber}</div>
                        <div class="text-xs">${statusText}</div>
                        ${ownerInfo ? `<div class="text-xs truncate w-full text-center">${ownerInfo}</div>` : ''}
                    </div>
                `;
            }
            
            buildingMap.innerHTML = stallsHtml;
        }

        function handleStallClick(building, stallNumber, status) {
            if (status === 'available') {
                // Open booking modal for available stalls
                openBookingModal(building, stallNumber);
            } else {
                // Show stall information for occupied/booked stalls
                showStallInfo(building, stallNumber, status);
            }
        }

        function openBookingModal(building, stallNumber) {
            currentSelectedStall = { building, stallNumber };
            document.getElementById('stallInfo').textContent = `${building} ‡πÅ‡∏ú‡∏á ${stallNumber}`;
            document.getElementById('bookingDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('stallBookingModal').classList.remove('hidden');
            document.getElementById('bookingName').focus();
        }

        function closeBookingModal() {
            document.getElementById('stallBookingModal').classList.add('hidden');
            document.getElementById('bookingForm').reset();
            currentSelectedStall = null;
        }

        function confirmBooking() {
            if (!currentSelectedStall) return;
            
            const name = document.getElementById('bookingName').value;
            const phone = document.getElementById('bookingPhone').value;
            const productType = document.getElementById('bookingProductType').value;
            const bookingDate = document.getElementById('bookingDate').value;
            const notes = document.getElementById('bookingNotes').value;
            
            if (!name || !phone || !productType || !bookingDate) {
                showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'warning');
                return;
            }
            
            const booking = {
                id: nextBookingId++,
                building: currentSelectedStall.building,
                stallNumber: currentSelectedStall.stallNumber,
                name: name,
                phone: phone,
                productType: productType,
                bookingDate: bookingDate,
                notes: notes,
                createdAt: new Date().toISOString()
            };
            
            bookings.push(booking);
            saveToStorage();
            closeBookingModal();
            renderBuildingMap();
            showMessage(`‡∏à‡∏≠‡∏á‡πÅ‡∏ú‡∏á ${currentSelectedStall.building} ‡πÅ‡∏ú‡∏á ${currentSelectedStall.stallNumber} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!`, 'success');
        }

        function showStallInfo(building, stallNumber, status) {
            let info = `${building} ‡πÅ‡∏ú‡∏á ${stallNumber}\n`;
            
            if (status === 'occupied' || status === 'expired' || status === 'expiring') {
                const rental = rentals.find(r => r.building === building && r.stallNumber === stallNumber);
                if (rental) {
                    info += `‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤: ${rental.tenantName}\n`;
                    info += `‡πÇ‡∏ó‡∏£: ${rental.phone || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}\n`;
                    info += `‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ${rental.productType}\n`;
                    info += `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${rental.paymentStatus}`;
                    
                    if (rental.contractEndDate) {
                        const daysLeft = getDaysUntilExpiry(rental.contractEndDate);
                        if (daysLeft !== null) {
                            info += `\n‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${daysLeft} ‡∏ß‡∏±‡∏ô`;
                            info += `\n‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏: ${new Date(rental.contractEndDate).toLocaleDateString('th-TH')}`;
                        }
                    }
                }
            } else if (status === 'booked') {
                const booking = bookings.find(b => b.building === building && b.stallNumber === stallNumber);
                if (booking) {
                    info += `‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á: ${booking.name}\n`;
                    info += `‡πÇ‡∏ó‡∏£: ${booking.phone}\n`;
                    info += `‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ${booking.productType}\n`;
                    info += `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏á: ${new Date(booking.bookingDate).toLocaleDateString('th-TH')}`;
                }
            }
            
            showMessage(info, 'warning');
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('th-TH').format(amount);
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            return new Date(dateString).toLocaleDateString('th-TH');
        }

        function getStatusClass(status) {
            switch(status) {
                case '‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÅ‡∏•‡πâ‡∏ß': return 'status-paid';
                case '‡∏£‡∏≠‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤': return 'status-pending';
                case '‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏': return 'status-overdue';
                default: return '';
            }
        }

        function getRowExpiryClass(daysLeft) {
            if (daysLeft === null || daysLeft > 30) return '';
            if (daysLeft <= 7) return 'row-expiring-critical';
            if (daysLeft <= 15) return 'row-expiring-warning';
            if (daysLeft <= 30) return 'row-expiring-info';
            return '';
        }

        function showMessage(text, type = 'success') {
            const message = document.getElementById('successMessage');
            const messageText = message.querySelector('span:last-child');
            const messageIcon = message.querySelector('span:first-child');
            
            messageText.textContent = text;
            
            // Reset classes
            message.className = 'fixed top-4 left-4 right-4 p-4 rounded-lg shadow-lg transform -translate-y-full opacity-0 transition-all duration-300 z-50';
            
            if (type === 'success') {
                message.classList.add('bg-green-500', 'text-white');
                messageIcon.textContent = '‚úÖ';
            } else if (type === 'error') {
                message.classList.add('bg-red-500', 'text-white');
                messageIcon.textContent = '‚ùå';
            } else if (type === 'warning') {
                message.classList.add('bg-yellow-500', 'text-white');
                messageIcon.textContent = '‚ö†Ô∏è';
            } else if (type === 'info') {
                message.classList.add('bg-blue-500', 'text-white');
                messageIcon.textContent = '‚ÑπÔ∏è';
            }
            
            message.style.transform = 'translateY(0)';
            message.style.opacity = '1';
            setTimeout(() => {
                message.style.transform = 'translateY(-100%)';
                message.style.opacity = '0';
            }, 3000);
        }

        function showConfirmModal(text, onConfirm) {
            const modal = document.getElementById('confirmModal');
            const confirmText = document.getElementById('confirmText');
            const confirmYes = document.getElementById('confirmYes');
            const confirmNo = document.getElementById('confirmNo');
            
            confirmText.textContent = text;
            modal.classList.remove('hidden');
            
            confirmYes.onclick = () => {
                modal.classList.add('hidden');
                onConfirm();
            };
            
            confirmNo.onclick = () => {
                modal.classList.add('hidden');
            };
        }

        function getProductTypeEmoji(type) {
            const emojis = {
                '‡∏ú‡∏±‡∏Å-‡∏ú‡∏•‡πÑ‡∏°‡πâ': 'ü•¨',
                '‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå': 'ü•©',
                '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏´‡πâ‡∏á': 'üåæ',
                '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∏‡∏á': 'üßÇ',
                '‡∏Ç‡∏ô‡∏°-‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°': 'üç™',
                '‡∏≠‡∏∑‡πà‡∏ô‡πÜ': 'üì¶'
            };
            return emojis[type] || 'üì¶';
        }

        function renderSpreadsheet(rentalsToRender = rentals) {
            const spreadsheetBody = document.getElementById('spreadsheetBody');
            const recordCount = document.getElementById('recordCount');
            const totalAmount = document.getElementById('totalAmount');
            
            recordCount.textContent = `${rentalsToRender.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
            
            const total = rentalsToRender.reduce((sum, rental) => sum + (parseFloat(rental.lockFee) || 0) + (parseFloat(rental.commonFee) || 0), 0);
            totalAmount.textContent = formatCurrency(total);

            // Sort rentals by building and then by stall number
            const sortedRentals = [...rentalsToRender].sort((a, b) => {
                // First sort by building
                const buildingA = a.building || '';
                const buildingB = b.building || '';
                
                if (buildingA !== buildingB) {
                    // Handle special case for "‡πÇ‡∏ã‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á" - put it at the end
                    if (buildingA === '‡πÇ‡∏ã‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á') return 1;
                    if (buildingB === '‡πÇ‡∏ã‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á') return -1;
                    
                    // Extract building letters for proper sorting (A, B, C, etc.)
                    const letterA = buildingA.replace('‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ ', '');
                    const letterB = buildingB.replace('‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ ', '');
                    return letterA.localeCompare(letterB);
                }
                
                // If buildings are the same, sort by stall number
                const stallA = a.stallNumber || '';
                const stallB = b.stallNumber || '';
                
                // Try to parse as numbers for proper numeric sorting
                const numA = parseInt(stallA);
                const numB = parseInt(stallB);
                
                if (!isNaN(numA) && !isNaN(numB)) {
                    return numA - numB;
                }
                
                // If not numbers, sort alphabetically
                return stallA.localeCompare(stallB);
            });

            if (sortedRentals.length === 0) {
                spreadsheetBody.innerHTML = `
                    <tr>
                        <td colspan="16" class="text-center text-gray-500 py-8">
                            <div>
                                <span class="text-4xl mb-2 block">üìä</span>
                                <p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡πÅ‡∏ú‡∏á</p>
                                <p class="text-sm">‡∏•‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏≥‡∏≠‡∏∑‡πà‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            spreadsheetBody.innerHTML = sortedRentals.map((rental, index) => {
                const daysLeft = getDaysUntilExpiry(rental.contractEndDate);
                const rowClass = getRowExpiryClass(daysLeft);
                const daysLeftText = daysLeft !== null ? 
                    (daysLeft <= 0 ? '‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß' : `${daysLeft} ‡∏ß‡∏±‡∏ô`) : 
                    '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                
                return `
                    <tr class="fade-in ${rowClass}">
                        <td class="row-number">${index + 1}</td>
                        <td class="editable-cell" onclick="editCell(${rental.id}, 'tenantName', this)">${rental.tenantName}</td>
                        <td class="editable-cell" onclick="editCell(${rental.id}, 'building', this)">${rental.building || ''}</td>
                        <td class="editable-cell" onclick="editCell(${rental.id}, 'stallNumber', this)">${rental.stallNumber}</td>
                        <td class="editable-cell" onclick="editCell(${rental.id}, 'productType', this)">${rental.productType}</td>
                        <td class="editable-cell" onclick="editCell(${rental.id}, 'phone', this)">
                            ${rental.phone ? `<a href="tel:${rental.phone}" class="text-blue-600 hover:underline">${rental.phone}</a>` : ''}
                        </td>
                        <td class="editable-cell text-right" onclick="editCell(${rental.id}, 'lockFee', this)">${formatCurrency(rental.lockFee || 0)}</td>
                        <td class="editable-cell text-right" onclick="editCell(${rental.id}, 'commonFee', this)">${formatCurrency(rental.commonFee || 0)}</td>
                        <td class="text-right font-semibold text-green-600">${formatCurrency((rental.lockFee || 0) + (rental.commonFee || 0))}</td>
                        <td class="editable-cell" onclick="editCell(${rental.id}, 'contractStartDate', this)">${formatDate(rental.contractStartDate)}</td>
                        <td class="editable-cell" onclick="editCell(${rental.id}, 'contractEndDate', this)">${formatDate(rental.contractEndDate)}</td>
                        <td class="text-center ${daysLeft !== null && daysLeft <= 7 ? 'text-red-600 font-bold' : daysLeft !== null && daysLeft <= 15 ? 'text-yellow-600 font-semibold' : daysLeft !== null && daysLeft <= 30 ? 'text-blue-600' : ''}">${daysLeftText}</td>
                        <td class="editable-cell ${getStatusClass(rental.paymentStatus)}" onclick="editCell(${rental.id}, 'paymentStatus', this)">${rental.paymentStatus}</td>
                        <td class="editable-cell" onclick="editCell(${rental.id}, 'paymentDate', this)">${rental.paymentDate || ''}</td>
                        <td class="editable-cell" onclick="editCell(${rental.id}, 'notes', this)">${rental.notes || ''}</td>
                        <td class="text-center">
                            <button onclick="deleteRental(${rental.id})" 
                                    class="text-red-500 hover:text-red-700 p-1 rounded" title="‡∏•‡∏ö">
                                üóëÔ∏è
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function editCell(id, field, cellElement) {
            const rental = rentals.find(r => r.id === id);
            if (!rental) return;
            
            const currentValue = rental[field] || '';
            const originalContent = cellElement.innerHTML;
            
            let inputElement;
            if (field === 'building') {
                inputElement = document.createElement('select');
                inputElement.className = 'cell-input';
                const buildingOptions = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z'];
                let optionsHtml = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£</option>';
                buildingOptions.forEach(letter => {
                    const value = `‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ ${letter}`;
                    optionsHtml += `<option value="${value}" ${currentValue === value ? 'selected' : ''}>${value}</option>`;
                });
                optionsHtml += `<option value="‡πÇ‡∏ã‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á" ${currentValue === '‡πÇ‡∏ã‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á' ? 'selected' : ''}>‡πÇ‡∏ã‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á</option>`;
                inputElement.innerHTML = optionsHtml;
            } else if (field === 'productType') {
                // Check if current value is a standard option or custom
                const standardOptions = ['‡∏ú‡∏±‡∏Å-‡∏ú‡∏•‡πÑ‡∏°‡πâ', '‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå', '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏´‡πâ‡∏á', '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∏‡∏á', '‡∏Ç‡∏ô‡∏°-‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°', '‡∏≠‡∏∑‡πà‡∏ô‡πÜ'];
                const isCustomValue = !standardOptions.includes(currentValue) && currentValue !== '';
                
                if (isCustomValue) {
                    // If it's a custom value, show input field directly
                    inputElement = document.createElement('input');
                    inputElement.type = 'text';
                    inputElement.className = 'cell-input';
                    inputElement.value = currentValue;
                    inputElement.placeholder = '‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
                } else {
                    // Show select dropdown for standard options
                    inputElement = document.createElement('select');
                    inputElement.className = 'cell-input';
                    inputElement.innerHTML = `
                        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</option>
                        <option value="‡∏ú‡∏±‡∏Å-‡∏ú‡∏•‡πÑ‡∏°‡πâ" ${currentValue === '‡∏ú‡∏±‡∏Å-‡∏ú‡∏•‡πÑ‡∏°‡πâ' ? 'selected' : ''}>‡∏ú‡∏±‡∏Å-‡∏ú‡∏•‡πÑ‡∏°‡πâ</option>
                        <option value="‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå" ${currentValue === '‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå' ? 'selected' : ''}>‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå</option>
                        <option value="‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏´‡πâ‡∏á" ${currentValue === '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏´‡πâ‡∏á' ? 'selected' : ''}>‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏´‡πâ‡∏á</option>
                        <option value="‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∏‡∏á" ${currentValue === '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∏‡∏á' ? 'selected' : ''}>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∏‡∏á</option>
                        <option value="‡∏Ç‡∏ô‡∏°-‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°" ${currentValue === '‡∏Ç‡∏ô‡∏°-‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°' ? 'selected' : ''}>‡∏Ç‡∏ô‡∏°-‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</option>
                        <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ" ${currentValue === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' ? 'selected' : ''}>‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                        <option value="custom">‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏£‡∏∞‡∏ö‡∏∏)</option>
                    `;
                }
            } else if (field === 'paymentStatus') {
                inputElement = document.createElement('select');
                inputElement.className = 'cell-input';
                inputElement.innerHTML = `
                    <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
                    <option value="‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÅ‡∏•‡πâ‡∏ß" ${currentValue === '‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÅ‡∏•‡πâ‡∏ß' ? 'selected' : ''}>‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÅ‡∏•‡πâ‡∏ß</option>
                    <option value="‡∏£‡∏≠‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤" ${currentValue === '‡∏£‡∏≠‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤' ? 'selected' : ''}>‡∏£‡∏≠‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤</option>
                    <option value="‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏" ${currentValue === '‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏' ? 'selected' : ''}>‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</option>
                `;
            } else if (field === 'lockFee' || field === 'commonFee') {
                inputElement = document.createElement('input');
                inputElement.type = 'number';
                inputElement.className = 'cell-input';
                inputElement.value = currentValue;
            } else if (field === 'contractStartDate' || field === 'contractEndDate') {
                inputElement = document.createElement('input');
                inputElement.type = 'date';
                inputElement.className = 'cell-input';
                inputElement.value = currentValue;
            } else if (field === 'paymentDate') {
                inputElement = document.createElement('select');
                inputElement.className = 'cell-input';
                inputElement.innerHTML = `
                    <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞</option>
                    <option value="‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô" ${currentValue === '‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô' ? 'selected' : ''}>‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                    <option value="‡∏£‡∏≤‡∏¢10‡∏ß‡∏±‡∏ô" ${currentValue === '‡∏£‡∏≤‡∏¢10‡∏ß‡∏±‡∏ô' ? 'selected' : ''}>‡∏£‡∏≤‡∏¢10‡∏ß‡∏±‡∏ô</option>
                `;
            } else {
                inputElement = document.createElement('input');
                inputElement.type = 'text';
                inputElement.className = 'cell-input';
                inputElement.value = currentValue;
            }
            
            cellElement.innerHTML = '';
            cellElement.appendChild(inputElement);
            inputElement.focus();
            
            function saveEdit() {
                const newValue = inputElement.value;
                rental[field] = newValue;
                saveToStorage();
                renderSpreadsheet();
                showMessage('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!', 'success');
            }
            
            function cancelEdit() {
                cellElement.innerHTML = originalContent;
            }
            
            inputElement.addEventListener('blur', saveEdit);
            inputElement.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    saveEdit();
                } else if (e.key === 'Escape') {
                    cancelEdit();
                }
            });
        }

        function deleteRental(id) {
            showConfirmModal(
                '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
                () => {
                    rentals = rentals.filter(rental => rental.id !== id);
                    saveToStorage();
                    renderSpreadsheet();
                    showMessage('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!', 'success');
                }
            );
        }

        function addNewRow() {
            const newRental = {
                id: nextId++,
                tenantName: '',
                building: '',
                stallNumber: '',
                productType: '',
                phone: '',
                lockFee: 0,
                commonFee: 0,
                contractStartDate: '',
                contractEndDate: '',
                paymentStatus: '',
                paymentDate: '',
                notes: '',
                createdAt: new Date().toISOString()
            };
            
            rentals.unshift(newRental);
            saveToStorage();
            renderSpreadsheet();
            showMessage('‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!', 'success');
        }

        // Export data to CSV
        function exportData() {
            if (rentals.length === 0) {
                showMessage('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å', 'warning');
                return;
            }

            const headers = ['‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤', '‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£', '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÅ‡∏ú‡∏á', '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå', '‡∏Ñ‡πà‡∏≤‡∏•‡πá‡∏≠‡∏Ñ', '‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á', '‡∏£‡∏ß‡∏°', '‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏±‡∏ç‡∏ç‡∏≤', '‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤', '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞', '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'];
            const csvContent = [
                headers.join(','),
                ...rentals.map(rental => {
                    const daysLeft = getDaysUntilExpiry(rental.contractEndDate);
                    const daysLeftText = daysLeft !== null ? 
                        (daysLeft <= 0 ? '‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß' : `${daysLeft} ‡∏ß‡∏±‡∏ô`) : 
                        '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                    
                    return [
                        `"${rental.tenantName}"`,
                        `"${rental.building || ''}"`,
                        `"${rental.stallNumber}"`,
                        `"${rental.productType}"`,
                        `"${rental.phone || ''}"`,
                        `"${rental.lockFee || 0}"`,
                        `"${rental.commonFee || 0}"`,
                        `"${(rental.lockFee || 0) + (rental.commonFee || 0)}"`,
                        `"${formatDate(rental.contractStartDate)}"`,
                        `"${formatDate(rental.contractEndDate)}"`,
                        `"${daysLeftText}"`,
                        `"${rental.paymentStatus || ''}"`,
                        `"${rental.paymentDate || ''}"`,
                        `"${rental.notes || ''}"`,
                        `"${new Date(rental.createdAt).toLocaleDateString('th-TH')}"`
                    ].join(',');
                })
            ].join('\n');

            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡πÅ‡∏ú‡∏á_${new Date().toLocaleDateString('th-TH').replace(/\//g, '-')}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showMessage('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!', 'success');
        }

        // Import data from CSV/JSON
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    if (file.name.endsWith('.csv')) {
                        const text = e.target.result;
                        const lines = text.split('\n');
                        const importedRentals = [];
                        
                        // Skip header row
                        for (let i = 1; i < lines.length; i++) {
                            const line = lines[i].trim();
                            if (!line) continue;
                            
                            const columns = line.split(',').map(col => col.replace(/"/g, '').trim());
                            if (columns.length >= 2 && columns[0] && columns[2]) {
                                importedRentals.push({
                                    id: nextId++,
                                    tenantName: columns[0],
                                    building: columns[1] || '',
                                    stallNumber: columns[2],
                                    productType: columns[3] || '',
                                    phone: columns[4] || '',
                                    lockFee: parseFloat(columns[5]) || 0,
                                    commonFee: parseFloat(columns[6]) || 0,
                                    contractStartDate: columns[8] || '',
                                    contractEndDate: columns[9] || '',
                                    paymentStatus: columns[11] || '',
                                    paymentDate: columns[12] || '',
                                    notes: columns[13] || '',
                                    createdAt: new Date().toISOString()
                                });
                            }
                        }
                        
                        if (importedRentals.length > 0) {
                            rentals = [...importedRentals, ...rentals];
                            saveToStorage();
                            renderSpreadsheet();
                            showMessage(`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${importedRentals.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!`, 'success');
                        } else {
                            showMessage('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå', 'error');
                        }
                    } else if (file.name.endsWith('.json')) {
                        const data = JSON.parse(e.target.result);
                        if (Array.isArray(data) && data.length > 0) {
                            const importedRentals = data.map(rental => ({
                                ...rental,
                                id: nextId++,
                                createdAt: rental.createdAt || new Date().toISOString()
                            }));
                            rentals = [...importedRentals, ...rentals];
                            saveToStorage();
                            renderSpreadsheet();
                            showMessage(`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${importedRentals.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!`, 'success');
                        } else {
                            showMessage('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå JSON ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
                        }
                    }
                } catch (error) {
                    showMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå', 'error');
                }
            };
            reader.readAsText(file, 'UTF-8');
            event.target.value = '';
        }

        // Backup data
        function backupData() {
            if (rentals.length === 0) {
                showMessage('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏™‡∏≥‡∏£‡∏≠‡∏á', 'warning');
                return;
            }

            const backupData = {
                rentals: rentals,
                bookings: bookings,
                nextId: nextId,
                nextBookingId: nextBookingId,
                backupDate: new Date().toISOString(),
                version: '2.0'
            };

            const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡πÅ‡∏ú‡∏á_${new Date().toLocaleDateString('th-TH').replace(/\//g, '-')}.json`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showMessage('‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!', 'success');
        }

        // Restore data
        function restoreData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);
                    
                    if (backupData.rentals && Array.isArray(backupData.rentals)) {
                        showConfirmModal(
                            `‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏£‡∏≠‡∏á ${backupData.rentals.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`,
                            () => {
                                rentals = backupData.rentals;
                                bookings = backupData.bookings || [];
                                nextId = backupData.nextId || (Math.max(...rentals.map(r => r.id)) + 1);
                                nextBookingId = backupData.nextBookingId || (Math.max(...bookings.map(b => b.id)) + 1);
                                saveToStorage();
                                renderSpreadsheet();
                                showMessage(`‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${rentals.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!`, 'success');
                            }
                        );
                    } else {
                        showMessage('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡∏£‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
                    }
                } catch (error) {
                    showMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡∏£‡∏≠‡∏á', 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // Clear all data function
        function clearAllData() {
            if (rentals.length === 0) {
                showMessage('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏•‡πâ‡∏≤‡∏á', 'warning');
                return;
            }
            
            showConfirmModal(
                `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${rentals.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ`,
                () => {
                    rentals = [];
                    bookings = [];
                    nextId = 1;
                    nextBookingId = 1;
                    saveToStorage();
                    renderSpreadsheet();
                    showMessage('‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!', 'success');
                }
            );
        }

        // Google Sheets functions
        function showGoogleSheetsModal() {
            document.getElementById('googleSheetsModal').classList.remove('hidden');
            document.getElementById('googleSheetsUrl').focus();
        }

        function closeGoogleSheetsModal() {
            document.getElementById('googleSheetsModal').classList.add('hidden');
            document.getElementById('googleSheetsUrl').value = '';
        }

        function extractSheetId(url) {
            const match = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
            return match ? match[1] : null;
        }

        async function importFromGoogleSheets() {
            const url = document.getElementById('googleSheetsUrl').value.trim();
            if (!url) {
                showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå Google Sheets', 'warning');
                return;
            }

            const sheetId = extractSheetId(url);
            if (!sheetId) {
                showMessage('‡∏•‡∏¥‡∏á‡∏Å‡πå Google Sheets ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
                return;
            }

            try {
                showMessage('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', 'warning');
                
                // Convert to CSV export URL
                const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=0`;
                
                const response = await fetch(csvUrl);
                if (!response.ok) {
                    throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á Google Sheets ‡πÑ‡∏î‡πâ');
                }
                
                const csvText = await response.text();
                const lines = csvText.split('\n');
                const importedRentals = [];
                
                // Skip header row and process data
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    // Parse CSV line (handle quoted values)
                    const columns = [];
                    let current = '';
                    let inQuotes = false;
                    
                    for (let j = 0; j < line.length; j++) {
                        const char = line[j];
                        if (char === '"') {
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            columns.push(current.trim());
                            current = '';
                        } else {
                            current += char;
                        }
                    }
                    columns.push(current.trim());
                    
                    // Create rental object if we have minimum required data
                    if (columns.length >= 2 && columns[0] && columns[2]) {
                        importedRentals.push({
                            id: nextId++,
                            tenantName: columns[0] || '',
                            building: columns[1] || '',
                            stallNumber: columns[2] || '',
                            productType: columns[3] || '',
                            phone: columns[4] || '',
                            lockFee: parseFloat(columns[5]) || 0,
                            commonFee: parseFloat(columns[6]) || 0,
                            contractStartDate: columns[8] || '',
                            contractEndDate: columns[9] || '',
                            paymentStatus: columns[11] || '',
                            paymentDate: columns[12] || '',
                            notes: columns[13] || '',
                            createdAt: new Date().toISOString()
                        });
                    }
                }
                
                if (importedRentals.length > 0) {
                    rentals = [...importedRentals, ...rentals];
                    saveToStorage();
                    renderSpreadsheet();
                    closeGoogleSheetsModal();
                    showMessage(`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets ${importedRentals.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!`, 'success');
                } else {
                    showMessage('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ô Google Sheets', 'error');
                }
                
            } catch (error) {
                console.error('Error importing from Google Sheets:', error);
                showMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Google Sheets ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏î‡∏π‡πÑ‡∏î‡πâ', 'error');
            }
        }

        document.getElementById('rentalForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Get product type value
            const productTypeSelect = document.getElementById('productType').value;
            const customProductType = document.getElementById('customProductType').value;
            const finalProductType = productTypeSelect === 'custom' ? customProductType : productTypeSelect;
            
            const rental = {
                id: nextId++,
                tenantName: document.getElementById('tenantName').value,
                building: document.getElementById('building').value,
                stallNumber: document.getElementById('stallNumber').value,
                productType: finalProductType,
                phone: document.getElementById('phoneNumber').value,
                lockFee: parseFloat(document.getElementById('lockFee').value) || 0,
                commonFee: parseFloat(document.getElementById('commonFee').value) || 0,
                contractStartDate: document.getElementById('contractStartDate').value,
                contractEndDate: document.getElementById('contractEndDate').value,
                paymentStatus: document.getElementById('paymentStatus').value,
                paymentDate: document.getElementById('paymentDate').value,
                notes: document.getElementById('notes').value,
                createdAt: new Date().toISOString()
            };

            rentals.unshift(rental);
            saveToStorage();
            renderSpreadsheet();
            
            // Reset form
            this.reset();
            
            showMessage('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!', 'success');
        });

        document.getElementById('searchInput').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const filteredRentals = rentals.filter(rental => 
                rental.tenantName.toLowerCase().includes(searchTerm) ||
                (rental.building || '').toLowerCase().includes(searchTerm) ||
                rental.stallNumber.toLowerCase().includes(searchTerm) ||
                rental.productType.toLowerCase().includes(searchTerm) ||
                rental.paymentStatus.toLowerCase().includes(searchTerm) ||
                rental.notes.toLowerCase().includes(searchTerm)
            );
            renderSpreadsheet(filteredRentals);
        });

        // Auto-update notifications every minute
        setInterval(() => {
            generateNotifications();
            updateNotificationBadge();
            if (!document.getElementById('notificationsPanel').classList.contains('hidden')) {
                renderNotifications();
            }
        }, 60000);

        // Initialize
        document.getElementById('formView').style.display = 'none';
        document.getElementById('contractStartDate').value = new Date().toISOString().split('T')[0];
        renderSpreadsheet();
        generateNotifications();
        updateNotificationBadge();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98e3ada1f2079c7d',t:'MTc2MDQwOTI3Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
