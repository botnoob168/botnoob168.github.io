<!doctype html>
<html lang="th" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wheel of Names</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
  <script src="/_sdk/element_sdk.js"></script>
  <style>
    body {
      box-sizing: border-box;
    }
    * {
      font-family: 'Kanit', sans-serif;
    }
    
    .wheel-shadow {
      box-shadow: 0 0 0 8px var(--wheel-border), 0 0 0 12px var(--wheel-border-outer), 0 10px 40px rgba(0,0,0,0.4);
    }
    
    .spin-btn {
      background: var(--btn-gradient);
      box-shadow: 0 4px 15px var(--btn-shadow);
    }
    
    .spin-btn:hover {
      filter: brightness(1.1);
    }
    
    .spin-btn:active {
      transform: scale(0.98);
    }
    
    .pointer-arrow {
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
    }
    
    .wheel-container {
      position: relative;
    }
    
    /* Confetti */
    .confetti-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 999;
      overflow: hidden;
    }
    
    .confetti {
      position: absolute;
      width: 10px;
      height: 10px;
      top: -20px;
      opacity: 0;
    }
    
    @keyframes confetti-fall {
      0% {
        transform: translateY(0) rotate(0deg) scale(1);
        opacity: 1;
      }
      100% {
        transform: translateY(100vh) rotate(720deg) scale(0.5);
        opacity: 0;
      }
    }
    
    @keyframes winner-pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.02); }
    }
    
    .winner-animation {
      animation: winner-pulse 0.5s ease-in-out 3;
    }
    
    @keyframes fade-in {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .fade-in {
      animation: fade-in 0.3s ease-out;
    }
    
    .textarea-names {
      line-height: 1.8;
    }
    
    .textarea-names:focus {
      outline: none;
      border-color: var(--accent-color);
    }

    .names-scroll::-webkit-scrollbar {
      width: 6px;
    }
    .names-scroll::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 3px;
    }
    .names-scroll::-webkit-scrollbar-thumb {
      background: var(--accent-light);
      border-radius: 3px;
    }
    .names-scroll::-webkit-scrollbar-thumb:hover {
      background: var(--accent-color);
    }
    
    /* Theme selector */
    .theme-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 3px solid transparent;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .theme-btn:hover {
      transform: scale(1.1);
    }
    
    .theme-btn.active {
      border-color: #333;
      box-shadow: 0 0 0 2px white, 0 0 0 4px #333;
    }
    
    .theme-vivid {
      background: linear-gradient(135deg, #e74c3c, #9b59b6, #3498db);
    }
    
    .theme-pastel {
      background: linear-gradient(135deg, #ffb3ba, #bae1ff, #baffc9);
    }
    
    .theme-dark {
      background: linear-gradient(135deg, #2c3e50, #34495e, #1a252f);
    }
    
    /* Theme variables */
    :root {
      --bg-gradient-from: #7c3aed;
      --bg-gradient-via: #9333ea;
      --bg-gradient-to: #4f46e5;
      --wheel-border: #5c4d8a;
      --wheel-border-outer: #3d3266;
      --btn-gradient: linear-gradient(180deg, #8b5cf6 0%, #6d28d9 100%);
      --btn-shadow: rgba(109, 40, 217, 0.4);
      --accent-color: #8b5cf6;
      --accent-light: #c4b5fd;
      --result-text: #7c3aed;
      --title-color: #fbbf24;
    }
    
    [data-theme="pastel"] {
      --bg-gradient-from: #fce7f3;
      --bg-gradient-via: #ddd6fe;
      --bg-gradient-to: #cffafe;
      --wheel-border: #f9a8d4;
      --wheel-border-outer: #e879f9;
      --btn-gradient: linear-gradient(180deg, #f9a8d4 0%, #f472b6 100%);
      --btn-shadow: rgba(244, 114, 182, 0.4);
      --accent-color: #f472b6;
      --accent-light: #fbcfe8;
      --result-text: #db2777;
      --title-color: #be185d;
    }
    
    [data-theme="dark"] {
      --bg-gradient-from: #1e293b;
      --bg-gradient-via: #0f172a;
      --bg-gradient-to: #020617;
      --wheel-border: #475569;
      --wheel-border-outer: #334155;
      --btn-gradient: linear-gradient(180deg, #475569 0%, #334155 100%);
      --btn-shadow: rgba(51, 65, 85, 0.6);
      --accent-color: #64748b;
      --accent-light: #94a3b8;
      --result-text: #f1f5f9;
      --title-color: #f8fafc;
    }
    
    .main-bg {
      background: linear-gradient(135deg, var(--bg-gradient-from), var(--bg-gradient-via), var(--bg-gradient-to));
    }
    
    .result-text-color {
      color: var(--result-text);
    }
    
    .title-color {
      color: var(--title-color);
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full overflow-auto"><!-- Confetti Container -->
  <div id="confetti-container" class="confetti-container"></div>
  <div id="app-wrapper" class="min-h-full w-full">
   <div class="flex flex-col lg:flex-row min-h-full"><!-- Left Sidebar - Names Input -->
    <aside class="w-full lg:w-80 bg-white p-4 lg:min-h-full order-2 lg:order-1 relative">
     <div class="flex flex-col h-full"><!-- Header -->
      <div class="flex items-center justify-between mb-3">
       <h2 id="secret-trigger" class="text-lg font-semibold text-gray-700 cursor-default select-none">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</h2><span id="name-count" class="text-sm text-gray-500 bg-gray-100 px-2 py-1 rounded">0 ‡∏ä‡∏∑‡πà‡∏≠</span>
      </div><!-- Names Textarea -->
      <div class="flex-1 mb-3"><label for="names-textarea" class="sr-only">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label> <textarea id="names-textarea" class="textarea-names w-full h-64 lg:h-80 p-3 border-2 border-gray-200 rounded-lg text-gray-700 text-sm resize-none names-scroll" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠ (‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠)

‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:
‡∏™‡∏°‡∏ä‡∏≤‡∏¢
‡∏™‡∏°‡∏´‡∏ç‡∏¥‡∏á
‡∏™‡∏°‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå"></textarea>
      </div><!-- Action Buttons -->
      <div class="flex gap-2 mb-3"><button id="sort-btn" class="flex-1 py-2 px-3 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 transition-all text-sm font-medium flex items-center justify-center gap-1">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12" />
        </svg> ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö </button> <button id="shuffle-btn" class="flex-1 py-2 px-3 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 transition-all text-sm font-medium flex items-center justify-center gap-1">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
        </svg> ‡∏™‡∏∏‡πà‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö </button>
      </div><!-- Theme Selector -->
      <div class="border-t pt-3 mb-3">
       <p class="text-sm font-medium text-gray-600 mb-2">‡∏ò‡∏µ‡∏°‡∏™‡∏µ</p>
       <div class="flex gap-3"><button id="theme-vivid" class="theme-btn theme-vivid active" title="‡∏™‡∏µ‡∏™‡∏î‡πÉ‡∏™"></button> <button id="theme-pastel" class="theme-btn theme-pastel" title="‡∏û‡∏≤‡∏™‡πÄ‡∏ó‡∏•"></button> <button id="theme-dark" class="theme-btn theme-dark" title="‡∏°‡∏∑‡∏î"></button>
       </div>
      </div><!-- Hidden Admin Panel -->
      <div id="admin-section" class="border-t pt-3 hidden">
       <div class="flex items-center gap-2 mb-2">
        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg><span class="text-sm font-medium text-gray-500">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</span>
       </div>
       <div class="flex gap-2"><label for="lock-select" class="sr-only">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Ñ</label> <select id="lock-select" class="flex-1 px-3 py-2 border border-gray-200 rounded-lg text-gray-500 text-sm focus:outline-none focus:border-gray-300 bg-gray-50"> <option value="">‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</option> </select>
       </div>
       <div id="lock-status" class="mt-2 hidden">
        <div class="flex items-center gap-2 bg-gray-50 border border-gray-200 rounded-lg px-3 py-2">
         <svg class="w-3 h-3 text-gray-400" fill="currentColor" viewbox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
         </svg><span class="text-gray-500 text-xs flex-1">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß: <span id="locked-name" class="font-medium"></span></span> <button id="unlock-btn" class="text-gray-400 hover:text-gray-600 text-xs">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
        </div>
       </div>
      </div>
     </div>
    </aside><!-- Main Content - Wheel -->
    <main class="main-bg flex-1 flex flex-col items-center justify-center p-6 lg:p-10 order-1 lg:order-2"><!-- Wheel Title -->
     <h1 id="wheel-title" class="title-color text-2xl lg:text-3xl font-bold mb-6 text-center drop-shadow-lg">üé≤ ‡∏ß‡∏á‡∏•‡πâ‡∏≠ üé≤</h1><!-- Wheel Container -->
     <div class="wheel-container relative mb-8"><!-- Pointer -->
      <div class="pointer-arrow absolute -right-2 top-1/2 -translate-y-1/2 z-20">
       <svg width="40" height="40" viewbox="0 0 40 40"><polygon points="40,10 40,30 5,20" fill="#fbbf24" stroke="#f59e0b" stroke-width="2" />
       </svg>
      </div><!-- Wheel -->
      <div class="wheel-shadow rounded-full relative z-10">
       <canvas id="wheel" width="400" height="400" class="rounded-full"></canvas>
      </div><!-- Center Button --> <button id="spin-btn" class="spin-btn absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-24 h-24 rounded-full text-white font-bold text-lg transition-all z-10 disabled:opacity-50"> ‡∏´‡∏°‡∏∏‡∏ô </button>
     </div><!-- Result Display -->
     <div id="result-container" class="hidden w-full max-w-md">
      <div id="result-box" class="bg-white rounded-2xl p-6 text-center shadow-2xl fade-in">
       <p class="text-gray-500 text-sm mb-2">üéâ ‡∏ú‡∏π‡πâ‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ‡∏Ñ‡∏∑‡∏≠ üéâ</p>
       <p id="result-name" class="text-3xl font-bold result-text-color mb-4"></p>
       <div class="flex gap-3 justify-center"><button id="remove-winner-btn" class="px-4 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition-all text-sm font-medium"> ‡∏•‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ </button> <button id="close-result-btn" class="px-4 py-2 bg-violet-100 text-violet-600 rounded-lg hover:bg-violet-200 transition-all text-sm font-medium"> ‡∏õ‡∏¥‡∏î </button>
       </div>
      </div>
     </div>
    </main>
   </div>
  </div>
  <script>
    // Default config
    const defaultConfig = {
      wheel_title: '‡∏™‡∏∏‡πà‡∏°‡∏Ñ‡∏ô‡∏•‡πâ‡∏≤‡∏á‡∏à‡∏≤‡∏ô',
      theme: 'vivid'
    };
    
    let config = { ...defaultConfig };
    
    // Theme color palettes
    const themeColors = {
      vivid: [
        '#e74c3c', '#9b59b6', '#3498db', '#1abc9c', 
        '#2ecc71', '#f1c40f', '#e67e22', '#e91e63',
        '#00bcd4', '#8bc34a', '#ff9800', '#673ab7'
      ],
      pastel: [
        '#ffb3ba', '#ffdfba', '#ffffba', '#baffc9',
        '#bae1ff', '#e2baff', '#ffbae1', '#baffea',
        '#ffd4ba', '#d4baff', '#baffd4', '#ffbad4'
      ],
      dark: [
        '#5c6bc0', '#7e57c2', '#26a69a', '#66bb6a',
        '#ffa726', '#ef5350', '#42a5f5', '#ab47bc',
        '#26c6da', '#9ccc65', '#ffca28', '#ec407a'
      ]
    };
    
    let currentColors = themeColors.vivid;
    
    // Audio Context for sounds
    let audioContext = null;
    
    function initAudio() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }
      if (audioContext.state === 'suspended') {
        audioContext.resume();
      }
    }
    
    function playTickSound() {
      if (!audioContext) return;
      
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      oscillator.frequency.value = 800 + Math.random() * 400;
      oscillator.type = 'sine';
      
      gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
      gainNode.gain.linearRampToValueAtTime(0.01, audioContext.currentTime + 0.05);
      
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.05);
    }
    
    function playWinSound() {
      if (!audioContext) return;
      
      const notes = [523.25, 659.25, 783.99, 1046.50];
      
      notes.forEach((freq, i) => {
        setTimeout(() => {
          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();
          
          oscillator.connect(gainNode);
          gainNode.connect(audioContext.destination);
          
          oscillator.frequency.value = freq;
          oscillator.type = 'sine';
          
          gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
          gainNode.gain.linearRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
          
          oscillator.start(audioContext.currentTime);
          oscillator.stop(audioContext.currentTime + 0.3);
        }, i * 100);
      });
    }
    
    // Confetti
    function createConfetti() {
      const container = document.getElementById('confetti-container');
      container.innerHTML = '';
      
      const shapes = ['square', 'circle'];
      
      for (let i = 0; i < 100; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        
        const color = currentColors[Math.floor(Math.random() * currentColors.length)];
        const shape = shapes[Math.floor(Math.random() * shapes.length)];
        const left = Math.random() * 100;
        const delay = Math.random() * 0.5;
        const duration = 2 + Math.random() * 2;
        const size = 8 + Math.random() * 8;
        
        confetti.style.left = left + '%';
        confetti.style.width = size + 'px';
        confetti.style.height = size + 'px';
        confetti.style.backgroundColor = color;
        confetti.style.borderRadius = shape === 'circle' ? '50%' : '2px';
        confetti.style.animation = `confetti-fall ${duration}s ease-out ${delay}s forwards`;
        
        container.appendChild(confetti);
      }
      
      setTimeout(() => {
        container.innerHTML = '';
      }, 5000);
    }
    
    // State
    let names = [];
    let lockedName = null;
    let isSpinning = false;
    let currentRotation = 0;
    let lastWinnerIndex = -1;
    let isAdminMode = false;
    let lastTickRotation = 0;

    // DOM Elements
    const canvas = document.getElementById('wheel');
    const ctx = canvas.getContext('2d');
    const namesTextarea = document.getElementById('names-textarea');
    const nameCountEl = document.getElementById('name-count');
    const sortBtn = document.getElementById('sort-btn');
    const shuffleBtn = document.getElementById('shuffle-btn');
    const lockSelect = document.getElementById('lock-select');
    const lockStatus = document.getElementById('lock-status');
    const lockedNameEl = document.getElementById('locked-name');
    const unlockBtn = document.getElementById('unlock-btn');
    const spinBtn = document.getElementById('spin-btn');
    const resultContainer = document.getElementById('result-container');
    const resultBox = document.getElementById('result-box');
    const resultName = document.getElementById('result-name');
    const removeWinnerBtn = document.getElementById('remove-winner-btn');
    const closeResultBtn = document.getElementById('close-result-btn');
    const secretTrigger = document.getElementById('secret-trigger');
    const adminSection = document.getElementById('admin-section');
    const wheelTitle = document.getElementById('wheel-title');
    const themeVividBtn = document.getElementById('theme-vivid');
    const themePastelBtn = document.getElementById('theme-pastel');
    const themeDarkBtn = document.getElementById('theme-dark');
    
    // Secret tap counter
    let tapCount = 0;
    let tapTimer = null;
    
    function handleSecretTap() {
      tapCount++;
      
      clearTimeout(tapTimer);
      tapTimer = setTimeout(() => {
        tapCount = 0;
      }, 2000);
      
      if (tapCount >= 5) {
        tapCount = 0;
        isAdminMode = !isAdminMode;
        
        if (isAdminMode) {
          adminSection.classList.remove('hidden');
        } else {
          adminSection.classList.add('hidden');
        }
      }
    }
    
    function setTheme(theme) {
      config.theme = theme;
      document.body.setAttribute('data-theme', theme);
      currentColors = themeColors[theme];
      
      // Update active button
      [themeVividBtn, themePastelBtn, themeDarkBtn].forEach(btn => btn.classList.remove('active'));
      if (theme === 'vivid') themeVividBtn.classList.add('active');
      else if (theme === 'pastel') themePastelBtn.classList.add('active');
      else if (theme === 'dark') themeDarkBtn.classList.add('active');
      
      drawWheel();
      
      if (window.elementSdk) {
        window.elementSdk.setConfig({ theme });
      }
    }

    function parseNames() {
      const text = namesTextarea.value;
      names = text.split('\n')
        .map(n => n.trim())
        .filter(n => n.length > 0);
      updateNameCount();
      updateLockSelect();
      drawWheel();
    }

    function updateNameCount() {
      nameCountEl.textContent = names.length + ' ‡∏ä‡∏∑‡πà‡∏≠';
    }

    function updateLockSelect() {
      const currentValue = lockSelect.value;
      lockSelect.innerHTML = '<option value="">‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</option>';
      names.forEach((name, i) => {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        lockSelect.appendChild(option);
      });
      if (names.includes(currentValue)) {
        lockSelect.value = currentValue;
      } else {
        lockedName = null;
        lockStatus.classList.add('hidden');
      }
    }

    function drawWheel() {
      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;
      const radius = Math.min(centerX, centerY) - 5;

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      if (names.length === 0) {
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
        ctx.fillStyle = config.theme === 'dark' ? '#1e293b' : '#4a4366';
        ctx.fill();
        
        ctx.fillStyle = config.theme === 'dark' ? '#64748b' : '#8b83a8';
        ctx.font = '18px Kanit';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢', centerX, centerY - 10);
        ctx.fillText('‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô', centerX, centerY + 15);
        return;
      }

      const sliceAngle = (2 * Math.PI) / names.length;

      ctx.save();
      ctx.translate(centerX, centerY);
      ctx.rotate((currentRotation * Math.PI) / 180);
      ctx.translate(-centerX, -centerY);

      names.forEach((name, i) => {
        const startAngle = i * sliceAngle - Math.PI / 2;
        const endAngle = startAngle + sliceAngle;

        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.arc(centerX, centerY, radius, startAngle, endAngle);
        ctx.closePath();
        ctx.fillStyle = currentColors[i % currentColors.length];
        ctx.fill();
        
        ctx.strokeStyle = 'rgba(255,255,255,0.3)';
        ctx.lineWidth = 1;
        ctx.stroke();

        ctx.save();
        ctx.translate(centerX, centerY);
        ctx.rotate(startAngle + sliceAngle / 2);
        ctx.textAlign = 'right';
        ctx.textBaseline = 'middle';
        
        // Text color based on theme
        if (config.theme === 'pastel') {
          ctx.fillStyle = '#374151';
        } else {
          ctx.fillStyle = '#ffffff';
        }
        
        ctx.font = 'bold 14px Kanit';
        ctx.shadowColor = 'rgba(0,0,0,0.3)';
        ctx.shadowBlur = 2;
        ctx.shadowOffsetX = 1;
        ctx.shadowOffsetY = 1;
        
        const maxLength = 12;
        const displayName = name.length > maxLength ? name.substring(0, maxLength) + '..' : name;
        ctx.fillText(displayName, radius - 15, 0);
        ctx.restore();
      });

      ctx.restore();

      // Border color from CSS variable
      const borderColor = getComputedStyle(document.documentElement).getPropertyValue('--wheel-border').trim() || '#5c4d8a';
      ctx.beginPath();
      ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
      ctx.strokeStyle = borderColor;
      ctx.lineWidth = 8;
      ctx.stroke();
    }

    function sortNames() {
      const sorted = [...names].sort((a, b) => a.localeCompare(b, 'th'));
      namesTextarea.value = sorted.join('\n');
      parseNames();
    }

    function shuffleNames() {
      const shuffled = [...names];
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      namesTextarea.value = shuffled.join('\n');
      parseNames();
    }

    function lockName() {
      const selected = lockSelect.value;
      if (selected && names.includes(selected)) {
        lockedName = selected;
        lockedNameEl.textContent = selected;
        lockStatus.classList.remove('hidden');
      } else {
        lockedName = null;
        lockStatus.classList.add('hidden');
      }
    }

    function unlock() {
      lockedName = null;
      lockStatus.classList.add('hidden');
      lockSelect.value = '';
    }

    function spin() {
      if (isSpinning || names.length < 2) return;
      
      initAudio();

      isSpinning = true;
      spinBtn.disabled = true;
      resultContainer.classList.add('hidden');

      let targetIndex;
      if (lockedName && names.includes(lockedName)) {
        targetIndex = names.indexOf(lockedName);
      } else {
        targetIndex = Math.floor(Math.random() * names.length);
      }
      
      lastWinnerIndex = targetIndex;

      const sliceAngle = 360 / names.length;
      const targetAngle = 90 - (targetIndex + 0.5) * sliceAngle;
      
      const edgeBuffer = sliceAngle * 0.15;
      const randomOffset = (Math.random() - 0.5) * (sliceAngle - 2 * edgeBuffer);
      
      const spins = 5 + Math.floor(Math.random() * 3);
      const baseRotation = spins * 360;
      
      let finalAngle = targetAngle + randomOffset;
      while (finalAngle < 0) finalAngle += 360;
      finalAngle = finalAngle % 360;
      
      const finalRotation = baseRotation + finalAngle;

      const startRotation = 0;
      currentRotation = 0;
      lastTickRotation = 0;
      
      const duration = 4000 + Math.random() * 1000;
      const startTime = Date.now();

      function animate() {
        const elapsed = Date.now() - startTime;
        const progress = Math.min(elapsed / duration, 1);
        
        const easeOut = 1 - Math.pow(1 - progress, 3);
        
        currentRotation = startRotation + (finalRotation - startRotation) * easeOut;
        
        // Tick sound
        const tickInterval = sliceAngle;
        if (Math.floor(currentRotation / tickInterval) > Math.floor(lastTickRotation / tickInterval)) {
          playTickSound();
        }
        lastTickRotation = currentRotation;
        
        drawWheel();

        if (progress < 1) {
          requestAnimationFrame(animate);
        } else {
          isSpinning = false;
          spinBtn.disabled = false;
          currentRotation = currentRotation % 360;
          
          // Celebrate!
          playWinSound();
          createConfetti();
          showResult(names[targetIndex]);
        }
      }

      animate();
    }

    function showResult(winner) {
      resultName.textContent = winner;
      resultContainer.classList.remove('hidden');
      resultBox.classList.remove('winner-animation');
      void resultBox.offsetWidth;
      resultBox.classList.add('winner-animation');
    }

    function removeWinner() {
      if (lastWinnerIndex >= 0 && lastWinnerIndex < names.length) {
        const winner = names[lastWinnerIndex];
        names.splice(lastWinnerIndex, 1);
        namesTextarea.value = names.join('\n');
        
        if (lockedName === winner) {
          unlock();
        }
        
        parseNames();
        resultContainer.classList.add('hidden');
        lastWinnerIndex = -1;
      }
    }
    
    function updateTitle(title) {
      wheelTitle.textContent = 'üé≤ ' + title + ' üé≤';
    }

    function init() {
      namesTextarea.addEventListener('input', parseNames);
      
      sortBtn.addEventListener('click', (e) => {
        e.preventDefault();
        sortNames();
      });
      
      shuffleBtn.addEventListener('click', (e) => {
        e.preventDefault();
        shuffleNames();
      });
      
      secretTrigger.addEventListener('click', handleSecretTap);
      
      lockSelect.addEventListener('change', lockName);
      
      unlockBtn.addEventListener('click', (e) => {
        e.preventDefault();
        unlock();
      });
      
      spinBtn.addEventListener('click', (e) => {
        e.preventDefault();
        spin();
      });
      
      removeWinnerBtn.addEventListener('click', (e) => {
        e.preventDefault();
        removeWinner();
      });
      
      closeResultBtn.addEventListener('click', (e) => {
        e.preventDefault();
        resultContainer.classList.add('hidden');
      });
      
      // Theme buttons
      themeVividBtn.addEventListener('click', (e) => {
        e.preventDefault();
        setTheme('vivid');
      });
      
      themePastelBtn.addEventListener('click', (e) => {
        e.preventDefault();
        setTheme('pastel');
      });
      
      themeDarkBtn.addEventListener('click', (e) => {
        e.preventDefault();
        setTheme('dark');
      });

      namesTextarea.value = '‡∏™‡∏°‡∏ä‡∏≤‡∏¢\n‡∏™‡∏°‡∏´‡∏ç‡∏¥‡∏á\n‡∏™‡∏°‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå\n‡∏™‡∏°‡∏®‡∏£‡∏µ\n‡∏™‡∏°‡∏õ‡∏≠‡∏á\n‡∏™‡∏°‡πÉ‡∏à';
      parseNames();
      updateTitle(config.wheel_title);
    }

    // Element SDK
    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig: defaultConfig,
        onConfigChange: async (newConfig) => {
          config = { ...defaultConfig, ...newConfig };
          
          // Update title
          if (config.wheel_title) {
            updateTitle(config.wheel_title);
          }
          
          // Update theme
          if (config.theme) {
            setTheme(config.theme);
          }
        },
        mapToCapabilities: (config) => ({
          recolorables: [],
          borderables: [],
          fontEditable: undefined,
          fontSizeable: undefined
        }),
        mapToEditPanelValues: (config) => new Map([
          ['wheel_title', config.wheel_title || defaultConfig.wheel_title]
        ])
      });
    }

    init();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9b6704db24adcbe1',t:'MTc2NzE1NTE4OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
